<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>余额分账流程数据转换 - 实时演示</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .demo-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.85rem;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .json-viewer {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-success {
            background: #52c41a;
            color: white;
        }

        .btn-success:hover {
            background: #389e0d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .process-flow {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .flow-step {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .flow-step h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .flow-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .flow-detail {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
        }

        .flow-detail label {
            font-weight: 600;
            color: #2c3e50;
            display: block;
            margin-bottom: 3px;
            font-size: 0.8rem;
        }

        .flow-detail span {
            color: #666;
            font-size: 0.8rem;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success { background: #52c41a; }
        .status-warning { background: #faad14; }
        .status-error { background: #ff4d4f; }

        .full-width {
            grid-column: 1 / -1;
        }

        .chart-container {
            height: 400px;
            margin-top: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
        }

        .funnel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 20px;
        }

        .funnel-step {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 30px;
            margin: 5px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            position: relative;
            transition: all 0.3s ease;
            min-width: 300px;
        }

        .funnel-step:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .funnel-step:nth-child(1) { width: 100%; }
        .funnel-step:nth-child(2) { width: 85%; }
        .funnel-step:nth-child(3) { width: 70%; }
        .funnel-step:nth-child(4) { width: 55%; }
        .funnel-step:nth-child(5) { width: 40%; }

        .funnel-percentage {
            position: absolute;
            right: -80px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            min-width: 60px;
            text-align: center;
        }

        .funnel-count {
            position: absolute;
            left: -80px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            min-width: 60px;
            text-align: center;
        }

        .tab-btn {
            padding: 8px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            color: #ff6b35;
            border-bottom-color: #ff6b35;
        }

        .tab-btn:hover {
            color: #ff6b35;
        }

        .funnel-step-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .funnel-step-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .funnel-step-count {
            color: #666;
            font-size: 0.9rem;
        }

        .funnel-conversion-arrow {
            text-align: center;
            margin: 5px 0;
            color: #667eea;
            font-weight: 600;
        }

        /* 模态框样式 */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* 漏斗编辑器样式 */
        .funnel-section {
            margin-bottom: 30px;
        }

        .funnel-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .required {
            color: #ff4d4f;
        }

        .help-icon {
            color: #999;
            cursor: help;
            margin-left: 5px;
        }

        .help-text {
            font-size: 0.9rem;
            color: #666;
            font-weight: normal;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .chart-type-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .chart-type-btn {
            padding: 12px 8px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            min-height: 60px;
        }

        .chart-type-btn .icon {
            font-size: 1.2rem;
        }

        .chart-type-btn.active {
            border-color: #ff6b35;
            background: #fff2ed;
            color: #ff6b35;
        }

        .chart-type-btn:hover {
            border-color: #ff6b35;
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-label input[type="radio"] {
            width: auto;
        }

        /* 漏斗步骤样式 */
        .funnel-steps-container {
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            background: #f8f9fa;
        }

        .funnel-step-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            cursor: move;
        }

        .funnel-step-item:last-child {
            margin-bottom: 0;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .step-number {
            width: 24px;
            height: 24px;
            background: #ff6b35;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .step-event {
            flex: 1;
        }

        .step-event select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .remove-step {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .remove-step:hover {
            color: #ff4d4f;
        }

        .filter-conditions {
            margin-top: 10px;
        }

        .filter-condition {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .filter-condition select {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .add-filter-btn {
            background: #f8f9fa;
            border: 1px dashed #ddd;
            color: #666;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .add-filter-btn:hover {
            background: #e9ecef;
        }

        .add-step-btn {
            width: 100%;
            background: #ff6b35;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
        }

        .add-step-btn:hover {
            background: #e55a2b;
        }

        @media (max-width: 1200px) {
            .demo-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .flow-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔄 余额分账流程数据转换</h1>
            <p>实时演示API数据转换为设计界面格式</p>
        </div>

        <!-- 统计信息 -->
        <div class="demo-panel">
            <h2 class="panel-title">
                <span>📊</span>
                数据统计
            </h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalRecords">0</div>
                    <div class="stat-label">总记录数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="convertedRecords">0</div>
                    <div class="stat-label">已转换</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="processNodes">0</div>
                    <div class="stat-label">流程节点</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uniqueUsers">0</div>
                    <div class="stat-label">用户数</div>
                </div>
            </div>
        </div>

        <!-- 控制面板 -->
        <div class="demo-panel">
            <h2 class="panel-title">
                <span>🎛️</span>
                控制面板
            </h2>
            <div class="controls">
                <button class="btn btn-primary" onclick="loadSampleData()">加载示例数据</button>
                <button class="btn btn-primary" onclick="loadRealData()">获取真实数据</button>
                <button class="btn btn-primary" onclick="loadBatchData()">批量获取数据</button>
                <button class="btn btn-secondary" onclick="validateToken()">验证令牌</button>
                <button class="btn btn-secondary" onclick="convertData()">转换数据</button>
                <button class="btn btn-success" onclick="exportData()">导出结果</button>
                <button class="btn btn-secondary" onclick="generateDemoFunnel()">生成演示漏斗</button>
                <button class="btn btn-secondary" onclick="openFunnelEditor()">编辑漏斗</button>
                <button class="btn btn-secondary" onclick="clearData()">清空数据</button>
            </div>
            
            <!-- API配置区域 -->
            <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                <h4 style="margin-bottom: 10px; color: #2c3e50;">API配置</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">项目ID:</label>
                        <input type="text" id="projectId" value="event1021" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">埋点ID:</label>
                        <input type="text" id="selectedPointId" value="110" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">查询日期:</label>
                        <input type="date" id="queryDate" value="2025-10-10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">页面大小:</label>
                        <input type="number" id="pageSize" value="30" min="1" max="100" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">访问令牌:</label>
                    <input type="password" id="accessToken" placeholder="请输入access-token" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
            </div>
        </div>

        <!-- 数据展示区域 -->
        <div class="demo-grid">
            <!-- 原始API数据 -->
            <div class="demo-panel">
                <h2 class="panel-title">
                    <span>📥</span>
                    原始API数据
                </h2>
                <div class="json-viewer" id="originalData">
                    点击"加载示例数据"开始演示...
                </div>
            </div>

            <!-- 转换后数据 -->
            <div class="demo-panel">
                <h2 class="panel-title">
                    <span>📤</span>
                    转换后数据
                </h2>
                <div class="json-viewer" id="convertedData">
                    点击"转换数据"查看结果...
                </div>
            </div>
        </div>

        <!-- 表格展示 -->
        <div class="demo-panel full-width">
            <h2 class="panel-title">
                <span>📋</span>
                转换结果表格
            </h2>
            <div style="overflow-x: auto;">
                <table class="data-table" id="resultTable">
                    <thead>
                        <tr>
                            <th>流程节点</th>
                            <th>页面名称</th>
                            <th>类型</th>
                            <th>行为</th>
                            <th>自定义内容</th>
                            <th>结果</th>
                            <th>版本</th>
                            <th>耗时</th>
                            <th>用户标识</th>
                            <th>商户标识</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="10" style="text-align: center; color: #999; padding: 20px;">
                                暂无数据，请先加载和转换数据
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 漏斗图分析 -->
        <div class="demo-panel full-width">
            <h2 class="panel-title">
                <span>📊</span>
                漏斗图分析
                <span style="font-size: 0.8rem; font-weight: normal; color: #666; margin-left: 10px;">
                    (<span id="funnelConfigName">基于漏斗配置生成</span>)
                </span>
            </h2>
            
            <!-- 漏斗概览 -->
            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <!-- 左侧漏斗概览 -->
                <div style="flex: 1; background: #f8f9fa; border-radius: 8px; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #2c3e50; margin-bottom: 10px;">
                            总转化率 <span id="totalConversionRate">0%</span>
                        </div>
                        <div style="width: 0; height: 0; border-left: 30px solid transparent; border-right: 30px solid transparent; border-top: 40px solid #667eea; margin: 0 auto;"></div>
                    </div>
                    
                    <div id="funnelOverview">
                        <div style="text-align: center; color: #999; padding: 20px;">
                            转换数据后将显示漏斗概览
                        </div>
                    </div>
                </div>
                
                <!-- 右侧图表区域 -->
                <div style="flex: 2;">
                    <!-- 标签页 -->
                    <div style="display: flex; border-bottom: 1px solid #e9ecef; margin-bottom: 15px;">
                        <button class="tab-btn active" onclick="switchFunnelTab('funnel')" id="funnelTab">漏斗</button>
                        <button class="tab-btn" onclick="switchFunnelTab('trend')" id="trendTab">趋势</button>
                        <button class="tab-btn" onclick="switchFunnelTab('table')" id="tableTab">表格</button>
                        <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                            <button style="background: none; border: none; cursor: pointer; padding: 5px;" onclick="refreshFunnelChart()">🔄</button>
                            <button style="background: none; border: none; cursor: pointer; padding: 5px;">⋯</button>
                        </div>
                    </div>
                    
                    <!-- 图表容器 -->
                    <div class="chart-container">
                        <div id="funnelChart" style="width: 100%; height: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 流程分析 -->
        <div class="demo-panel full-width">
            <h2 class="panel-title">
                <span>🔄</span>
                流程分析
            </h2>
            <div class="process-flow" id="processFlow">
                <div style="text-align: center; color: #999; padding: 20px;">
                    转换数据后将显示流程分析结果
                </div>
            </div>
        </div>
    </div>

    <!-- 漏斗编辑器模态框 -->
    <div id="funnelEditorModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>编辑漏斗</h2>
                <span class="close" onclick="closeFunnelEditor()">&times;</span>
            </div>
            
            <div class="modal-body">
                <!-- 基本设置 -->
                <div class="funnel-section">
                    <h3>基本设置</h3>
                    <div class="form-group">
                        <label>漏斗名称 <span class="required">*</span></label>
                        <input type="text" id="funnelName" value="余额分账流程" placeholder="请输入漏斗名称">
                    </div>
                    
                    <div class="form-group">
                        <label>转化周期 <span class="required">*</span> <span class="help-icon">?</span></label>
                        <select id="conversionCycle">
                            <option value="1">一天</option>
                            <option value="7">一周</option>
                            <option value="30">一月</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>图表默认类型 <span class="required">*</span></label>
                        <div class="chart-type-buttons">
                            <button class="chart-type-btn active" data-type="funnel">
                                <span class="icon">🔽</span> 漏斗图
                            </button>
                            <button class="chart-type-btn" data-type="trend">
                                <span class="icon">📈</span> 趋势
                            </button>
                            <button class="chart-type-btn" data-type="table">
                                <span class="icon">📋</span> 表格
                            </button>
                            <button class="chart-type-btn" data-type="value_card">
                                <span class="icon">🔢</span> 数值卡片
                            </button>
                            <button class="chart-type-btn" data-type="bar_chart">
                                <span class="icon">📊</span> 柱状图
                            </button>
                            <button class="chart-type-btn" data-type="multi_line">
                                <span class="icon">📉</span> 多折线图
                            </button>
                            <button class="chart-type-btn" data-type="bar_line">
                                <span class="icon">📊📈</span> 柱线图
                            </button>
                            <button class="chart-type-btn" data-type="stacked">
                                <span class="icon">📚</span> 堆叠图
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>计数ID <span class="required">*</span></label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="countId" value="builtin" checked>
                                <span class="radio-text">内置ID</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="countId" value="user">
                                <span class="radio-text">用户ID</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- 漏斗步骤 -->
                <div class="funnel-section">
                    <h3>漏斗步骤 <span class="help-text">(拖动可排序)</span> <span class="required">*</span></h3>
                    <div id="funnelSteps" class="funnel-steps-container">
                        <!-- 步骤将通过JavaScript动态生成 -->
                    </div>
                    <button class="add-step-btn" onclick="addFunnelStep()">
                        <span class="icon">+</span> 增加步骤
                    </button>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeFunnelEditor()">取消</button>
                <button class="btn btn-primary" onclick="saveFunnelConfig()">更新</button>
            </div>
        </div>
    </div>

    <script src="data_processor.js"></script>
    <script src="api_config.js"></script>
    <script>
        let currentData = [];
        let convertedData = [];
        let funnelChart = null;
        let currentFunnelTab = 'funnel';
        let yeepayAPI = new YeepayAPI();
        let funnelConfig = {
            name: '余额分账流程',
            conversionCycle: 1,
            defaultChartType: 'funnel',
            countId: 'builtin',
            steps: [
                {
                    id: 1,
                    event: 'page_view',
                    eventName: '页面浏览',
                    filters: [
                        { field: 'page_name', operator: 'contains', value: '' }
                    ]
                },
                {
                    id: 2,
                    event: 'button_click',
                    eventName: '按钮点击',
                    filters: [
                        { field: 'page_name', operator: 'contains', value: '' }
                    ]
                },
                {
                    id: 3,
                    event: 'button_click',
                    eventName: '按钮点击',
                    filters: [
                        { field: 'page_name', operator: 'contains', value: '' }
                    ]
                },
                {
                    id: 4,
                    event: 'form_submit',
                    eventName: '表单提交',
                    filters: [
                        { field: 'page_name', operator: 'contains', value: '' }
                    ]
                }
            ]
        };

        // 示例数据
        const sampleData = [
            {
                "id": 7743,
                "pageName": "易分账-分账-分账查询",
                "type": "query",
                "content": "{\"商户编号\":\"10086624159\",\"变更申请状态\":\"全部\"}",
                "weCustomerKey": "d56f0b85-32b9-452c-b445-5d07ba5970f7-20250729154128349",
                "weUserId": "10091502926",
                "wePath": "https://mp.yeepay.com/mp-galaxy/mp-separate-account/#/ledgerManage/ledger_query",
                "weDeviceName": "PC",
                "wePlatform": "Win32",
                "weSystem": "web ",
                "weOs": "web",
                "weBrowserName": "chrome",
                "weNewStatus": 2,
                "weIp": "10.201.77.173",
                "weCountry": "0",
                "weProvince": "0",
                "weCity": "内网IP",
                "createdAt": "2025-10-10T06:31:37.000Z"
            },
            {
                "id": 11350,
                "pageName": "易分账-分账-分账复核",
                "type": "页面",
                "stayTime": "30",
                "pageBehavior": "关闭",
                "weCustomerKey": "5c571dc8-bc1c-4d7d-ab79-48d485f64850-20250910111015940",
                "weUserId": "10091461782",
                "wePath": "https://mp.yeepay.com/mp-galaxy/mp-separate-account/#/ledgerManage/ledger_review",
                "weDeviceName": "PC",
                "wePlatform": "Win32",
                "weSystem": "web ",
                "weOs": "web",
                "weBrowserName": "chrome",
                "weNewStatus": 2,
                "weIp": "10.203.12.129",
                "weCountry": "0",
                "weProvince": "0",
                "weCity": "内网IP",
                "createdAt": "2025-10-10T06:31:49.000Z"
            },
            {
                "id": 7744,
                "pageName": "对账管理-对账中心-交易查询",
                "type": "query",
                "content": "{\"pageNo\":1,\"pageSize\":20,\"timeType\":\"ORDER_START\",\"tradeTime\":[\"2025-09-01 00:00:00\",\"2025-09-30 23:59:59\"]}",
                "weCustomerKey": "ec12ffb5-73f7-4e25-b2ba-bc63e7988f57-20250930091635927",
                "weUserId": "10091627110",
                "wePath": "https://mp.yeepay.com/mp-galaxy/mp-merchant-access/#/tradeManage/queryMerchant",
                "weDeviceName": "PC",
                "wePlatform": "Win32",
                "weSystem": "web ",
                "weOs": "web",
                "weBrowserName": "edge",
                "weNewStatus": 2,
                "weIp": "10.201.77.173",
                "weCountry": "0",
                "weProvince": "0",
                "weCity": "内网IP",
                "createdAt": "2025-10-10T06:31:36.000Z"
            },
            {
                "id": 7731,
                "pageName": "复核通过",
                "type": "click",
                "content": "确 认",
                "weCustomerKey": "e0a274bd-ac71-4855-b894-33a539412d47-20250926165105548",
                "weUserId": "10091448783",
                "wePath": "https://mp.yeepay.com/mp-galaxy/mp-separate-account/#/ledgerManage/ledger_review",
                "weDeviceName": "PC",
                "wePlatform": "Win32",
                "weSystem": "web ",
                "weOs": "web",
                "weBrowserName": "edge",
                "weNewStatus": 2,
                "weIp": "10.203.13.129",
                "weCountry": "0",
                "weProvince": "0",
                "weCity": "内网IP",
                "createdAt": "2025-10-10T06:31:19.000Z"
            },
            {
                "id": 7725,
                "pageName": "老板管账-商户变更",
                "type": "query",
                "content": "{\"变更类型\":\"全部\",\"申请时间\":\"其他\",\"完成时间\":\"其他\"}",
                "weCustomerKey": "d2118bfc-5a99-48c0-b187-6ad196c564fe-20250903165703653",
                "weUserId": "10091630318",
                "wePath": "https://mp.yeepay.com/mp-galaxy/mp-merchant-access/#/standardMerchantManage/querySubMerchantChange",
                "weDeviceName": "PC",
                "wePlatform": "Win32",
                "weSystem": "web ",
                "weOs": "web",
                "weBrowserName": "chrome",
                "weNewStatus": 2,
                "weIp": "10.201.77.173",
                "weCountry": "0",
                "weProvince": "0",
                "weCity": "内网IP",
                "createdAt": "2025-10-10T06:31:20.000Z"
            }
        ];

        // 加载示例数据
        function loadSampleData() {
            currentData = [...sampleData];
            document.getElementById('originalData').textContent = JSON.stringify(currentData, null, 2);
            updateStats();
        }

        // 获取真实数据
        async function loadRealData() {
            const projectId = document.getElementById('projectId').value;
            const selectedPointId = document.getElementById('selectedPointId').value;
            const queryDate = document.getElementById('queryDate').value;
            const pageSize = document.getElementById('pageSize').value;
            const accessToken = document.getElementById('accessToken').value;

            if (!accessToken) {
                alert('请输入访问令牌！');
                return;
            }

            // 显示加载状态
            document.getElementById('originalData').textContent = '正在获取数据...';
            showMessage('正在获取数据，请稍候...', 'info');
            
            try {
                const config = {
                    projectId: projectId,
                    selectedPointId: selectedPointId,
                    pageSize: pageSize,
                    date: queryDate
                };

                const result = await yeepayAPI.searchBuryPointData(config, accessToken);
                
                if (result.data && result.data.dataList) {
                    currentData = result.data.dataList;
                    document.getElementById('originalData').textContent = JSON.stringify(result, null, 2);
                    updateStats();
                    
                    // 显示成功消息
                    showMessage(`数据获取成功！共获取 ${currentData.length} 条记录`, 'success');
                } else {
                    throw new Error('返回数据格式不正确');
                }
                
            } catch (error) {
                console.error('获取数据失败:', error);
                document.getElementById('originalData').textContent = '数据获取失败: ' + error.message;
                showMessage('数据获取失败: ' + error.message, 'error');
            }
        }

        // 批量获取数据
        async function loadBatchData() {
            const projectId = document.getElementById('projectId').value;
            const selectedPointId = document.getElementById('selectedPointId').value;
            const queryDate = document.getElementById('queryDate').value;
            const pageSize = document.getElementById('pageSize').value;
            const accessToken = document.getElementById('accessToken').value;

            if (!accessToken) {
                alert('请输入访问令牌！');
                return;
            }

            // 显示加载状态
            document.getElementById('originalData').textContent = '正在批量获取数据...';
            showMessage('正在批量获取数据，这可能需要一些时间...', 'info');
            
            try {
                const config = {
                    projectId: projectId,
                    selectedPointId: selectedPointId,
                    pageSize: pageSize,
                    date: queryDate
                };

                const allData = await yeepayAPI.searchBuryPointDataBatch(config, accessToken, 5);
                
                if (allData.length > 0) {
                    currentData = allData;
                    document.getElementById('originalData').textContent = JSON.stringify({
                        code: 200,
                        msg: 'success',
                        data: {
                            total: allData.length,
                            dataList: allData
                        }
                    }, null, 2);
                    updateStats();
                    
                    // 显示成功消息
                    showMessage(`批量数据获取成功！共获取 ${allData.length} 条记录`, 'success');
                } else {
                    throw new Error('没有获取到任何数据');
                }
                
            } catch (error) {
                console.error('批量获取数据失败:', error);
                document.getElementById('originalData').textContent = '批量数据获取失败: ' + error.message;
                showMessage('批量数据获取失败: ' + error.message, 'error');
            }
        }

        // 验证令牌
        async function validateToken() {
            const accessToken = document.getElementById('accessToken').value;
            
            if (!accessToken) {
                alert('请输入访问令牌！');
                return;
            }

            showMessage('正在验证令牌...', 'info');
            
            try {
                const isValid = await yeepayAPI.validateToken(accessToken);
                if (isValid) {
                    showMessage('令牌验证成功！', 'success');
                } else {
                    showMessage('令牌验证失败，请检查令牌是否正确', 'error');
                }
            } catch (error) {
                showMessage('令牌验证失败: ' + error.message, 'error');
            }
        }

        // 显示消息提示
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                max-width: 300px;
                word-wrap: break-word;
                ${type === 'success' ? 'background: #52c41a;' : 
                  type === 'error' ? 'background: #ff4d4f;' : 
                  'background: #1890ff;'}
            `;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            // 3秒后自动移除
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }

        // 转换数据
        function convertData() {
            if (currentData.length === 0) {
                alert('请先加载数据！');
                return;
            }

            convertedData = processor.convertBatch(currentData);
            document.getElementById('convertedData').textContent = JSON.stringify(convertedData, null, 2);
            updateTable();
            updateProcessFlow();
            updateFunnelChart();
            updateStats();
        }

        // 更新统计信息
        function updateStats() {
            document.getElementById('totalRecords').textContent = currentData.length;
            document.getElementById('convertedRecords').textContent = convertedData.length;
            
            const processNodes = new Set(convertedData.map(item => item["流程节点"])).size;
            document.getElementById('processNodes').textContent = processNodes;
            
            const uniqueUsers = new Set(convertedData.map(item => item["用户标识"])).size;
            document.getElementById('uniqueUsers').textContent = uniqueUsers;
        }

        // 更新表格
        function updateTable() {
            const tableBody = document.getElementById('tableBody');
            
            if (convertedData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; color: #999; padding: 20px;">
                            暂无数据
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = convertedData.map(record => `
                <tr>
                    <td>${record["流程节点"]}</td>
                    <td>${record["页面名称"]}</td>
                    <td>${record["类型"]}</td>
                    <td>${record["行为"]}</td>
                    <td title="${record["自定义内容"]}">${record["自定义内容"]}</td>
                    <td>
                        <span class="status-indicator ${record["结果"] === '成功' ? 'status-success' : 'status-error'}"></span>
                        ${record["结果"]}
                    </td>
                    <td>${record["版本"]}</td>
                    <td>${record["耗时"]}s</td>
                    <td>${record["用户标识"]}</td>
                    <td>${record["商户标识"]}</td>
                </tr>
            `).join('');
        }

        // 更新流程分析
        function updateProcessFlow() {
            const flowContainer = document.getElementById('processFlow');
            
            if (convertedData.length === 0) {
                flowContainer.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        暂无数据
                    </div>
                `;
                return;
            }

            // 按流程节点分组
            const processGroups = {};
            convertedData.forEach(record => {
                const node = record["流程节点"];
                if (!processGroups[node]) {
                    processGroups[node] = [];
                }
                processGroups[node].push(record);
            });

            // 生成流程步骤
            const flowSteps = Object.entries(processGroups).map(([node, records]) => {
                const totalTime = records.reduce((sum, record) => sum + (parseInt(record["耗时"]) || 0), 0);
                const avgTime = Math.round(totalTime / records.length);
                const successRate = (records.filter(r => r["结果"] === "成功").length / records.length * 100).toFixed(1);

                return `
                    <div class="flow-step">
                        <h4>${node}</h4>
                        <div class="flow-details">
                            <div class="flow-detail">
                                <label>操作次数:</label>
                                <span>${records.length}</span>
                            </div>
                            <div class="flow-detail">
                                <label>平均耗时:</label>
                                <span>${avgTime}秒</span>
                            </div>
                            <div class="flow-detail">
                                <label>成功率:</label>
                                <span>${successRate}%</span>
                            </div>
                            <div class="flow-detail">
                                <label>涉及用户:</label>
                                <span>${new Set(records.map(r => r["用户标识"])).size}人</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            flowContainer.innerHTML = flowSteps;
        }

        // 导出数据
        function exportData() {
            if (convertedData.length === 0) {
                alert('请先转换数据！');
                return;
            }

            const csv = processor.exportToCSV(convertedData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', '余额分账流程数据.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 更新漏斗图
        function updateFunnelChart() {
            if (convertedData.length === 0) {
                document.getElementById('funnelSteps').innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        暂无数据
                    </div>
                `;
                return;
            }

            // 按流程节点统计
            const processStats = {};
            convertedData.forEach(record => {
                const node = record["流程节点"];
                if (!processStats[node]) {
                    processStats[node] = {
                        count: 0,
                        successCount: 0,
                        totalTime: 0
                    };
                }
                processStats[node].count++;
                if (record["结果"] === "成功") {
                    processStats[node].successCount++;
                }
                processStats[node].totalTime += parseInt(record["耗时"]) || 0;
            });

            // 使用漏斗配置中定义的步骤顺序
            const configuredSteps = funnelConfig.steps.map(step => step.eventName);
            
            // 根据配置的步骤顺序生成漏斗数据
            const funnelData = [];
            const funnelSteps = [];
            let maxCount = 0;

            configuredSteps.forEach(stepName => {
                const stats = processStats[stepName] || { count: 0, successCount: 0, totalTime: 0 };
                maxCount = Math.max(maxCount, stats.count);
                
                funnelData.push({
                    name: stepName,
                    value: stats.count
                });
                
                funnelSteps.push({
                    name: stepName,
                    count: stats.count,
                    successRate: stats.count > 0 ? ((stats.successCount / stats.count) * 100).toFixed(1) : '0.0',
                    avgTime: stats.count > 0 ? Math.round(stats.totalTime / stats.count) : 0
                });
            });

            // 更新ECharts漏斗图
            updateEChartsFunnel(funnelData);

            // 更新漏斗概览
            updateFunnelOverview(funnelData);

            // 更新HTML漏斗步骤
            updateHTMLFunnel(funnelSteps, maxCount);
        }

        // 更新ECharts漏斗图
        function updateEChartsFunnel(data) {
            const chartDom = document.getElementById('funnelChart');
            if (!chartDom) {
                console.error('漏斗图容器未找到');
                return;
            }

            if (!funnelChart) {
                funnelChart = echarts.init(chartDom);
            }

            // 如果没有数据，显示空状态
            if (!data || data.length === 0) {
                const emptyOption = {
                    title: {
                        text: '暂无漏斗图数据',
                        left: 'center',
                        top: 'center',
                        textStyle: {
                            color: '#999',
                            fontSize: 16
                        }
                    }
                };
                funnelChart.setOption(emptyOption);
                return;
            }

            const option = {
                title: {
                    text: '余额分账流程漏斗图',
                    left: 'center',
                    top: 20,
                    textStyle: {
                        color: '#2c3e50',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const unit = funnelConfig.countId === 'user' ? '人' : '次';
                        return `${params.name}<br/>操作${unit === '人' ? '人数' : '次数'}: ${params.value}${unit}<br/>占比: ${params.percent}%`;
                    }
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    top: 'middle',
                    data: data.map(item => item.name)
                },
                series: [
                    {
                        name: '流程步骤',
                        type: 'funnel',
                        left: '20%',
                        top: 60,
                        bottom: 60,
                        width: '60%',
                        min: 0,
                        max: Math.max(...data.map(item => item.value)),
                        minSize: '0%',
                        maxSize: '100%',
                        sort: 'descending',
                        gap: 2,
                        label: {
                            show: true,
                            position: 'inside',
                            formatter: function(params) {
                                const unit = funnelConfig.countId === 'user' ? '人' : '次';
                                return `${params.name}\n${params.value}${unit}`;
                            },
                            fontSize: 11,
                            color: '#fff',
                            fontWeight: 'bold'
                        },
                        labelLine: {
                            length: 10,
                            lineStyle: {
                                width: 1,
                                type: 'solid'
                            }
                        },
                        itemStyle: {
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        emphasis: {
                            label: {
                                fontSize: 13
                            },
                            itemStyle: {
                                shadowBlur: 10,
                                shadowColor: 'rgba(0, 0, 0, 0.3)'
                            }
                        },
                        data: data.map((item, index) => ({
                            ...item,
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: `hsl(${240 + index * 30}, 70%, 60%)` },
                                    { offset: 1, color: `hsl(${240 + index * 30}, 70%, 40%)` }
                                ])
                            }
                        }))
                    }
                ]
            };

            funnelChart.setOption(option, true);
            
            // 确保图表正确渲染
            setTimeout(() => {
                funnelChart.resize();
            }, 100);
        }

        // 更新HTML漏斗步骤
        function updateHTMLFunnel(steps, maxCount) {
            const container = document.getElementById('funnelSteps');
            
            if (steps.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        暂无数据
                    </div>
                `;
                return;
            }

            const funnelHTML = steps.map((step, index) => {
                const percentage = ((step.count / maxCount) * 100).toFixed(1);
                const width = Math.max(40, percentage);
                const unit = funnelConfig.countId === 'user' ? '人' : '次';
                
                return `
                    <div class="funnel-step" style="width: ${width}%;">
                        <div class="funnel-count">${step.count}${unit}</div>
                        ${step.name}
                        <div class="funnel-percentage">${percentage}%</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.9;">
                            成功率: ${step.successRate}% | 平均耗时: ${step.avgTime}s
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = funnelHTML;
        }

        // 切换漏斗标签页
        function switchFunnelTab(tabName) {
            currentFunnelTab = tabName;
            
            // 更新标签页状态
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // 根据标签页更新图表
            updateFunnelChartByTab();
        }

        // 根据标签页更新图表
        function updateFunnelChartByTab() {
            if (convertedData.length === 0) {
                updateEChartsFunnel([]);
                return;
            }

            switch(currentFunnelTab) {
                case 'funnel':
                    updateFunnelChart();
                    break;
                case 'trend':
                    updateTrendChart();
                    break;
                case 'table':
                    updateTableChart();
                    break;
                case 'value_card':
                    updateValueCardChart();
                    break;
                case 'bar_chart':
                    updateBarChart();
                    break;
                case 'multi_line':
                    updateMultiLineChart();
                    break;
                case 'bar_line':
                    updateBarLineChart();
                    break;
                case 'stacked':
                    updateStackedChart();
                    break;
            }
        }

        // 更新趋势图
        function updateTrendChart() {
            const chartDom = document.getElementById('funnelChart');
            if (!chartDom) return;

            if (!funnelChart) {
                funnelChart = echarts.init(chartDom);
            }

            // 生成模拟趋势数据
            const dates = [];
            const values = [];
            const today = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push((date.getMonth() + 1).toString().padStart(2, '0') + '-' + date.getDate().toString().padStart(2, '0'));
                values.push(Math.random() * 100);
            }

            const option = {
                title: {
                    text: '总转化率趋势',
                    left: 'center',
                    top: 20,
                    textStyle: {
                        color: '#2c3e50',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        return `${params[0].axisValue}<br/>转化率: ${params[0].value.toFixed(2)}%`;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: {
                        interval: 4
                    }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    axisLabel: {
                        formatter: '{value}%'
                    }
                },
                series: [{
                    name: '转化率',
                    type: 'line',
                    data: values,
                    smooth: true,
                    lineStyle: {
                        color: '#667eea',
                        width: 2
                    },
                    itemStyle: {
                        color: '#667eea'
                    },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(102, 126, 234, 0.3)' },
                            { offset: 1, color: 'rgba(102, 126, 234, 0.1)' }
                        ])
                    }
                }]
            };

            funnelChart.setOption(option, true);
        }

        // 更新表格图表
        function updateTableChart() {
            const chartDom = document.getElementById('funnelChart');
            if (!chartDom) return;

            if (!funnelChart) {
                funnelChart = echarts.init(chartDom);
            }

            // 生成表格数据
            const processStats = {};
            convertedData.forEach(record => {
                const node = record["流程节点"];
                if (!processStats[node]) {
                    processStats[node] = {
                        count: 0,
                        successCount: 0,
                        totalTime: 0
                    };
                }
                processStats[node].count++;
                if (record["结果"] === "成功") {
                    processStats[node].successCount++;
                }
                processStats[node].totalTime += parseInt(record["耗时"]) || 0;
            });

            const tableData = Object.entries(processStats).map(([name, stats]) => [
                name,
                stats.count,
                ((stats.successCount / stats.count) * 100).toFixed(1) + '%',
                Math.round(stats.totalTime / stats.count) + 's'
            ]);

            const option = {
                title: {
                    text: '流程数据表格',
                    left: 'center',
                    top: 20,
                    textStyle: {
                        color: '#2c3e50',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'item'
                },
                series: [{
                    type: 'table',
                    left: 'center',
                    top: 60,
                    width: '90%',
                    height: '70%',
                    data: [
                        ['流程节点', funnelConfig.countId === 'user' ? '操作人数' : '操作次数', '成功率', '平均耗时'],
                        ...tableData
                    ],
                    headerHeight: 40,
                    itemHeight: 30,
                    textStyle: {
                        fontSize: 12
                    }
                }]
            };

            funnelChart.setOption(option, true);
        }

        // 更新数值卡片
        function updateValueCardChart() {
            const chartDom = document.getElementById('funnelChart');
            if (!chartDom) return;

            if (!funnelChart) {
                funnelChart = echarts.init(chartDom);
            }

            // 计算总转化率
            const processStats = {};
            convertedData.forEach(record => {
                const node = record["流程节点"];
                if (!processStats[node]) {
                    processStats[node] = { count: 0, successCount: 0 };
                }
                processStats[node].count++;
                if (record["结果"] === "成功") {
                    processStats[node].successCount++;
                }
            });

            const steps = Object.values(processStats);
            const totalConversion = steps.length > 1 ? 
                ((steps[steps.length - 1].count / steps[0].count) * 100).toFixed(1) : 100;

            const option = {
                title: {
                    text: '总转化率',
                    left: 'center',
                    top: 'center',
                    textStyle: {
                        fontSize: 48,
                        fontWeight: 'bold',
                        color: '#ff6b35'
                    }
                },
                series: [{
                    type: 'gauge',
                    center: ['50%', '60%'],
                    radius: '80%',
                    min: 0,
                    max: 100,
                    splitNumber: 10,
                    axisLine: {
                        lineStyle: {
                            width: 6,
                            color: [
                                [0.3, '#ff6b35'],
                                [0.7, '#37a2da'],
                                [1, '#67e0e3']
                            ]
                        }
                    },
                    pointer: {
                        itemStyle: {
                            color: 'auto'
                        }
                    },
                    axisTick: {
                        distance: -30,
                        splitNumber: 5,
                        lineStyle: {
                            width: 2,
                            color: '#999'
                        }
                    },
                    splitLine: {
                        distance: -30,
                        length: 30,
                        lineStyle: {
                            width: 4,
                            color: '#999'
                        }
                    },
                    axisLabel: {
                        color: 'auto',
                        distance: 40,
                        fontSize: 20
                    },
                    detail: {
                        valueAnimation: true,
                        formatter: '{value}%',
                        color: 'auto',
                        fontSize: 30,
                        fontWeight: 'bold'
                    },
                    data: [{
                        value: totalConversion
                    }]
                }]
            };

            funnelChart.setOption(option, true);
        }

        // 更新柱状图
        function updateBarChart() {
            const chartDom = document.getElementById('funnelChart');
            if (!chartDom) return;

            if (!funnelChart) {
                funnelChart = echarts.init(chartDom);
            }

            const processStats = {};
            convertedData.forEach(record => {
                const node = record["流程节点"];
                if (!processStats[node]) {
                    processStats[node] = { count: 0, successCount: 0 };
                }
                processStats[node].count++;
                if (record["结果"] === "成功") {
                    processStats[node].successCount++;
                }
            });

            const configuredSteps = funnelConfig.steps.map(step => step.eventName);
            const data = configuredSteps.map(stepName => {
                const stats = processStats[stepName] || { count: 0, successCount: 0 };
                return {
                    name: stepName,
                    value: stats.count,
                    successRate: stats.count > 0 ? ((stats.successCount / stats.count) * 100).toFixed(1) : 0
                };
            });

            const option = {
                title: {
                    text: '流程步骤柱状图',
                    left: 'center',
                    top: 20,
                    textStyle: {
                        color: '#2c3e50',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const unit = funnelConfig.countId === 'user' ? '人' : '次';
                        return `${params[0].name}<br/>操作${unit === '人' ? '人数' : '次数'}: ${params[0].value}${unit}<br/>成功率: ${params[0].data.successRate}%`;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: data.map(item => item.name),
                    axisLabel: {
                        rotate: 45,
                        fontSize: 10
                    }
                },
                yAxis: {
                    type: 'value',
                    name: funnelConfig.countId === 'user' ? '人数' : '次数'
                },
                series: [{
                    name: '操作次数',
                    type: 'bar',
                    data: data,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#667eea' },
                            { offset: 1, color: '#764ba2' }
                        ])
                    },
                    emphasis: {
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#ff6b35' },
                                { offset: 1, color: '#e55a2b' }
                            ])
                        }
                    }
                }]
            };

            funnelChart.setOption(option, true);
        }

        // 更新多折线图
        function updateMultiLineChart() {
            const chartDom = document.getElementById('funnelChart');
            if (!chartDom) return;

            if (!funnelChart) {
                funnelChart = echarts.init(chartDom);
            }

            // 生成模拟的时间序列数据
            const dates = [];
            const today = new Date();
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push((date.getMonth() + 1).toString().padStart(2, '0') + '-' + date.getDate().toString().padStart(2, '0'));
            }

            const configuredSteps = funnelConfig.steps.map(step => step.eventName);
            const series = configuredSteps.map((stepName, index) => {
                const baseValue = 1000 - index * 100;
                const data = dates.map(() => Math.max(0, baseValue + Math.random() * 200 - 100));
                return {
                    name: stepName,
                    type: 'line',
                    data: data,
                    smooth: true,
                    lineStyle: {
                        width: 2
                    },
                    itemStyle: {
                        color: `hsl(${240 + index * 60}, 70%, 60%)`
                    }
                };
            });

            const option = {
                title: {
                    text: '流程步骤趋势图',
                    left: 'center',
                    top: 20,
                    textStyle: {
                        color: '#2c3e50',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const unit = funnelConfig.countId === 'user' ? '人' : '次';
                        let result = `${params[0].axisValue}<br/>`;
                        params.forEach(param => {
                            result += `${param.seriesName}: ${param.value}${unit}<br/>`;
                        });
                        return result;
                    }
                },
                legend: {
                    data: configuredSteps,
                    top: 50
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: {
                        interval: 4
                    }
                },
                yAxis: {
                    type: 'value',
                    name: funnelConfig.countId === 'user' ? '人数' : '次数'
                },
                series: series
            };

            funnelChart.setOption(option, true);
        }

        // 更新柱线图
        function updateBarLineChart() {
            const chartDom = document.getElementById('funnelChart');
            if (!chartDom) return;

            if (!funnelChart) {
                funnelChart = echarts.init(chartDom);
            }

            const processStats = {};
            convertedData.forEach(record => {
                const node = record["流程节点"];
                if (!processStats[node]) {
                    processStats[node] = { count: 0, successCount: 0 };
                }
                processStats[node].count++;
                if (record["结果"] === "成功") {
                    processStats[node].successCount++;
                }
            });

            const configuredSteps = funnelConfig.steps.map(step => step.eventName);
            const data = configuredSteps.map(stepName => {
                const stats = processStats[stepName] || { count: 0, successCount: 0 };
                return {
                    name: stepName,
                    value: stats.count,
                    successRate: stats.count > 0 ? ((stats.successCount / stats.count) * 100) : 0
                };
            });

            const option = {
                title: {
                    text: '流程步骤柱线图',
                    left: 'center',
                    top: 20,
                    textStyle: {
                        color: '#2c3e50',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                legend: {
                    data: ['操作次数', '成功率'],
                    top: 50
                },
                xAxis: {
                    type: 'category',
                    data: data.map(item => item.name),
                    axisLabel: {
                        rotate: 45,
                        fontSize: 10
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: funnelConfig.countId === 'user' ? '人数' : '次数',
                        position: 'left'
                    },
                    {
                        type: 'value',
                        name: '成功率(%)',
                        position: 'right',
                        max: 100
                    }
                ],
                series: [
                    {
                        name: '操作次数',
                        type: 'bar',
                        data: data.map(item => item.value),
                        itemStyle: {
                            color: '#667eea'
                        }
                    },
                    {
                        name: '成功率',
                        type: 'line',
                        yAxisIndex: 1,
                        data: data.map(item => item.successRate),
                        lineStyle: {
                            color: '#ff6b35'
                        },
                        itemStyle: {
                            color: '#ff6b35'
                        }
                    }
                ]
            };

            funnelChart.setOption(option, true);
        }

        // 更新堆叠图
        function updateStackedChart() {
            const chartDom = document.getElementById('funnelChart');
            if (!chartDom) return;

            if (!funnelChart) {
                funnelChart = echarts.init(chartDom);
            }

            const processStats = {};
            convertedData.forEach(record => {
                const node = record["流程节点"];
                if (!processStats[node]) {
                    processStats[node] = { count: 0, successCount: 0 };
                }
                processStats[node].count++;
                if (record["结果"] === "成功") {
                    processStats[node].successCount++;
                }
            });

            const configuredSteps = funnelConfig.steps.map(step => step.eventName);
            const data = configuredSteps.map(stepName => {
                const stats = processStats[stepName] || { count: 0, successCount: 0 };
                return {
                    name: stepName,
                    success: stats.successCount,
                    failed: stats.count - stats.successCount
                };
            });

            const option = {
                title: {
                    text: '流程步骤堆叠图',
                    left: 'center',
                    top: 20,
                    textStyle: {
                        color: '#2c3e50',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['成功', '失败'],
                    top: 50
                },
                xAxis: {
                    type: 'category',
                    data: data.map(item => item.name),
                    axisLabel: {
                        rotate: 45,
                        fontSize: 10
                    }
                },
                yAxis: {
                    type: 'value',
                    name: funnelConfig.countId === 'user' ? '人数' : '次数'
                },
                series: [
                    {
                        name: '成功',
                        type: 'bar',
                        stack: 'total',
                        data: data.map(item => item.success),
                        itemStyle: {
                            color: '#52c41a'
                        }
                    },
                    {
                        name: '失败',
                        type: 'bar',
                        stack: 'total',
                        data: data.map(item => item.failed),
                        itemStyle: {
                            color: '#ff4d4f'
                        }
                    }
                ]
            };

            funnelChart.setOption(option, true);
        }

        // 刷新漏斗图
        function refreshFunnelChart() {
            if (convertedData.length > 0) {
                updateFunnelChartByTab();
            } else {
                alert('请先加载和转换数据！');
            }
        }

        // 生成演示漏斗图
        function generateDemoFunnel() {
            // 生成基于真实业务场景的演示数据
            const demoSteps = [
                { name: '余额分账查询', value: 1000, successRate: 98.5, avgTime: 2 },
                { name: '分账操作', value: 850, successRate: 95.2, avgTime: 8 },
                { name: '分账复核', value: 720, successRate: 92.8, avgTime: 15 },
                { name: '安全验证', value: 650, successRate: 89.5, avgTime: 5 },
                { name: '系统提示', value: 580, successRate: 96.8, avgTime: 3 }
            ];
            
            // 更新ECharts漏斗图
            updateEChartsFunnel(demoSteps);
            
            // 更新漏斗概览
            updateFunnelOverview(demoSteps);
            
            // 更新HTML漏斗步骤
            const demoStepsForHTML = demoSteps.map(item => ({
                name: item.name,
                count: item.value,
                successRate: item.successRate.toFixed(1),
                avgTime: item.avgTime
            }));
            
            updateHTMLFunnel(demoStepsForHTML, 1000);
            
            showMessage('演示漏斗图已生成', 'success');
        }

        // 更新漏斗概览
        function updateFunnelOverview(data) {
            if (!data || data.length === 0) {
                document.getElementById('funnelOverview').innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        暂无数据
                    </div>
                `;
                document.getElementById('totalConversionRate').textContent = '0%';
                return;
            }

            const totalConversion = data.length > 1 ? 
                ((data[data.length - 1].value / data[0].value) * 100).toFixed(1) : 100;
            
            document.getElementById('totalConversionRate').textContent = totalConversion + '%';

            let overviewHTML = '';
            for (let i = 0; i < data.length; i++) {
                const item = data[i];
                const stepNumber = i + 1;
                
                // 使用漏斗配置中的步骤名称
                const stepConfig = funnelConfig.steps[i];
                const stepDisplayName = stepConfig ? stepConfig.eventName : item.name;
                
                // 根据计数ID类型确定单位
                const unit = funnelConfig.countId === 'user' ? '人' : '次';
                
                overviewHTML += `
                    <div class="funnel-step-item">
                        <div class="funnel-step-name">第${stepNumber}步 ${stepDisplayName}</div>
                        <div class="funnel-step-count">${item.value}${unit}</div>
                    </div>
                `;
                
                if (i < data.length - 1) {
                    const nextItem = data[i + 1];
                    const conversionRate = item.value > 0 ? ((nextItem.value / item.value) * 100).toFixed(1) : '0.0';
                    overviewHTML += `
                        <div class="funnel-conversion-arrow">
                            <div style="width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 20px solid #667eea; margin: 0 auto;"></div>
                            <div style="margin-top: 5px;">${conversionRate}%</div>
                        </div>
                    `;
                }
            }

            document.getElementById('funnelOverview').innerHTML = overviewHTML;
        }

        // 清空数据
        function clearData() {
            currentData = [];
            convertedData = [];
            document.getElementById('originalData').textContent = '点击"加载示例数据"开始演示...';
            document.getElementById('convertedData').textContent = '点击"转换数据"查看结果...';
            updateTable();
            updateProcessFlow();
            updateFunnelChart();
            updateStats();
        }

        // 漏斗编辑器功能
        function openFunnelEditor() {
            document.getElementById('funnelEditorModal').style.display = 'flex';
            loadFunnelConfig();
            renderFunnelSteps();
        }

        function closeFunnelEditor() {
            document.getElementById('funnelEditorModal').style.display = 'none';
        }

        function loadFunnelConfig() {
            document.getElementById('funnelName').value = funnelConfig.name;
            document.getElementById('conversionCycle').value = funnelConfig.conversionCycle;
            
            // 设置图表类型按钮
            document.querySelectorAll('.chart-type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === funnelConfig.defaultChartType) {
                    btn.classList.add('active');
                }
            });
            
            // 设置计数ID
            document.querySelector(`input[name="countId"][value="${funnelConfig.countId}"]`).checked = true;
        }

        function renderFunnelSteps() {
            const container = document.getElementById('funnelSteps');
            container.innerHTML = '';
            
            funnelConfig.steps.forEach((step, index) => {
                const stepElement = createStepElement(step, index + 1);
                container.appendChild(stepElement);
            });
        }

        function createStepElement(step, stepNumber) {
            const div = document.createElement('div');
            div.className = 'funnel-step-item';
            div.dataset.stepId = step.id;
            
            div.innerHTML = `
                <div class="step-header">
                    <div class="step-number">${stepNumber}</div>
                    <div class="step-event">
                        <select onchange="updateStepEvent(${step.id}, this.value)">
                            <option value="page_click" ${step.event === 'page_click' ? 'selected' : ''}>页面点击【通用新】</option>
                            <option value="page_view" ${step.event === 'page_view' ? 'selected' : ''}>页面浏览</option>
                            <option value="button_click" ${step.event === 'button_click' ? 'selected' : ''}>按钮点击</option>
                            <option value="form_submit" ${step.event === 'form_submit' ? 'selected' : ''}>表单提交</option>
                            <option value="custom_event" ${step.event === 'custom_event' ? 'selected' : ''}>自定义事件</option>
                        </select>
                    </div>
                    <button class="remove-step" onclick="removeFunnelStep(${step.id})">−</button>
                </div>
                <div class="filter-conditions">
                    ${step.filters.map((filter, index) => `
                        <div class="filter-condition">
                            <select onchange="updateFilterField(${step.id}, ${index}, 'field', this.value)">
                                <option value="builtin_id" ${filter.field === 'builtin_id' ? 'selected' : ''}>内置ID</option>
                                <option value="user_id" ${filter.field === 'user_id' ? 'selected' : ''}>用户ID</option>
                                <option value="page_name" ${filter.field === 'page_name' ? 'selected' : ''}>页面名称</option>
                                <option value="event_type" ${filter.field === 'event_type' ? 'selected' : ''}>事件类型</option>
                            </select>
                            <select onchange="updateFilterField(${step.id}, ${index}, 'operator', this.value)">
                                <option value="empty" ${filter.operator === 'empty' ? 'selected' : ''}>为空</option>
                                <option value="not_empty" ${filter.operator === 'not_empty' ? 'selected' : ''}>不为空</option>
                                <option value="equals" ${filter.operator === 'equals' ? 'selected' : ''}>等于</option>
                                <option value="not_equals" ${filter.operator === 'not_equals' ? 'selected' : ''}>不等于</option>
                                <option value="contains" ${filter.operator === 'contains' ? 'selected' : ''}>包含</option>
                            </select>
                            <button class="remove-step" onclick="removeFilter(${step.id}, ${index})">−</button>
                        </div>
                    `).join('')}
                    <button class="add-filter-btn" onclick="addFilter(${step.id})">+ 筛选条件</button>
                </div>
            `;
            
            return div;
        }

        function addFunnelStep() {
            const newId = Math.max(...funnelConfig.steps.map(s => s.id)) + 1;
            const newStep = {
                id: newId,
                event: 'page_click',
                eventName: '页面点击【通用新】',
                filters: [
                    { field: 'builtin_id', operator: 'empty', value: '' }
                ]
            };
            
            funnelConfig.steps.push(newStep);
            renderFunnelSteps();
        }

        function removeFunnelStep(stepId) {
            if (funnelConfig.steps.length <= 1) {
                alert('至少需要保留一个步骤');
                return;
            }
            
            funnelConfig.steps = funnelConfig.steps.filter(step => step.id !== stepId);
            renderFunnelSteps();
        }

        function updateStepEvent(stepId, eventType) {
            const step = funnelConfig.steps.find(s => s.id === stepId);
            if (step) {
                step.event = eventType;
                step.eventName = getEventName(eventType);
            }
        }

        function getEventName(eventType) {
            const eventNames = {
                'page_click': '页面点击【通用新】',
                'page_view': '页面浏览',
                'button_click': '按钮点击',
                'form_submit': '表单提交',
                'custom_event': '自定义事件'
            };
            return eventNames[eventType] || eventType;
        }

        function addFilter(stepId) {
            const step = funnelConfig.steps.find(s => s.id === stepId);
            if (step) {
                step.filters.push({
                    field: 'builtin_id',
                    operator: 'empty',
                    value: ''
                });
                renderFunnelSteps();
            }
        }

        function removeFilter(stepId, filterIndex) {
            const step = funnelConfig.steps.find(s => s.id === stepId);
            if (step && step.filters.length > 1) {
                step.filters.splice(filterIndex, 1);
                renderFunnelSteps();
            }
        }

        function updateFilterField(stepId, filterIndex, field, value) {
            const step = funnelConfig.steps.find(s => s.id === stepId);
            if (step && step.filters[filterIndex]) {
                step.filters[filterIndex][field] = value;
            }
        }

        function saveFunnelConfig() {
            // 收集表单数据
            funnelConfig.name = document.getElementById('funnelName').value;
            funnelConfig.conversionCycle = parseInt(document.getElementById('conversionCycle').value);
            
            const activeChartType = document.querySelector('.chart-type-btn.active');
            funnelConfig.defaultChartType = activeChartType ? activeChartType.dataset.type : 'funnel';
            
            const countIdRadio = document.querySelector('input[name="countId"]:checked');
            funnelConfig.countId = countIdRadio ? countIdRadio.value : 'builtin';
            
            // 验证必填字段
            if (!funnelConfig.name.trim()) {
                alert('请输入漏斗名称');
                return;
            }
            
            if (funnelConfig.steps.length === 0) {
                alert('请至少添加一个步骤');
                return;
            }
            
            // 切换到默认图表类型
            currentFunnelTab = funnelConfig.defaultChartType;
            updateFunnelTabs();
            
            // 保存配置并关闭编辑器
            closeFunnelEditor();
            showMessage('漏斗配置已保存', 'success');
            
            // 更新漏斗图标题
            document.getElementById('funnelConfigName').textContent = `${funnelConfig.name} - 基于漏斗配置生成`;
            
            // 如果有数据，重新生成漏斗图
            if (convertedData.length > 0) {
                updateFunnelChart();
            }
        }

        // 图表类型按钮切换
        document.addEventListener('click', function(e) {
            if (e.target.closest('.chart-type-btn')) {
                document.querySelectorAll('.chart-type-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                e.target.closest('.chart-type-btn').classList.add('active');
            }
        });

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            // 初始化漏斗图
            const chartDom = document.getElementById('funnelChart');
            if (chartDom) {
                funnelChart = echarts.init(chartDom);
                // 显示初始状态
                updateEChartsFunnel([]);
            }
        });

        // 窗口大小改变时重新调整图表
        window.addEventListener('resize', function() {
            if (funnelChart) {
                funnelChart.resize();
            }
        });
    </script>
</body>
</html>
