<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·è¡Œä¸ºåˆ†ææ¼æ–—å›¾æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #1890ff;
            margin-bottom: 15px;
        }
        .test-data {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .test-result {
            background: #e6f7ff;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #1890ff;
        }
        .test-button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #40a9ff;
        }
        .error {
            background: #fff2f0;
            border-left: 4px solid #ff4d4f;
            color: #ff4d4f;
        }
        .success {
            background: #f6ffed;
            border-left: 4px solid #52c41a;
            color: #52c41a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ ç”¨æˆ·è¡Œä¸ºåˆ†ææ¼æ–—å›¾åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="test-section">
            <div class="test-title">ğŸ“Š æµ‹è¯•æ•°æ®</div>
            <p>åŸºäºä½ æä¾›çš„çœŸå®æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä»¥ä¸‹æµ‹è¯•æ•°æ®ï¼š</p>
            
            <div class="test-data">
                <strong>è®¿é—®åŸ‹ç‚¹æ•°æ® (visitBuryPointId: 110):</strong><br>
                {
                    "id": 1954,
                    "pageName": "ä¸‹çº§å•†æˆ·æŸ¥è¯¢-appid é…ç½®",
                    "type": "é¡µé¢",
                    "stayTime": "0",
                    "pageBehavior": "æ‰“å¼€",
                    "weCustomerKey": "user-001",
                    "weUserId": "10091337639",
                    "createdAt": "2025-10-23T01:28:25.000Z"
                }
            </div>
            
            <div class="test-data">
                <strong>ç‚¹å‡»åŸ‹ç‚¹æ•°æ® (clickBuryPointId: 109):</strong><br>
                {
                    "id": 7645,
                    "pageName": "ä¼ä¸šä»˜æ¬¾-å¤æ ¸ç”³è¯·æŸ¥è¯¢",
                    "type": "query",
                    "content": "{\"ç”³è¯·æ—¶é—´\":\"å…¶ä»–\",\"çŠ¶æ€\":\"å…¨éƒ¨\"}",
                    "weCustomerKey": "user-001",
                    "weUserId": "10090768861",
                    "createdAt": "2025-10-23T01:28:35.000Z"
                }
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ”§ æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•</div>
            
            <button class="test-button" onclick="testDataProcessor()">æµ‹è¯•æ•°æ®å¤„ç†å™¨</button>
            <button class="test-button" onclick="testChartGenerator()">æµ‹è¯•å›¾è¡¨ç”Ÿæˆå™¨</button>
            <button class="test-button" onclick="testFullWorkflow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
            
            <div id="test-results"></div>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ“ˆ é¢„æœŸç»“æœ</div>
            <p>åŸºäºæµ‹è¯•æ•°æ®ï¼Œé¢„æœŸç”Ÿæˆçš„æ¼æ–—å›¾åº”è¯¥åŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š</p>
            <ul>
                <li><strong>æµç¨‹å¼€å§‹</strong> - ç”¨æˆ·è®¿é—®ä¸‹çº§å•†æˆ·æŸ¥è¯¢é¡µé¢ (100%)</li>
                <li><strong>å‘èµ·æŸ¥è¯¢æ“ä½œ</strong> - ç”¨æˆ·ç‚¹å‡»æŸ¥è¯¢æŒ‰é’® (è½¬åŒ–ç‡å¾…è®¡ç®—)</li>
                <li><strong>æµç¨‹ç»“æŸ</strong> - ç”¨æˆ·å®Œæˆæ“ä½œ (è½¬åŒ–ç‡å¾…è®¡ç®—)</li>
            </ul>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ¯ å®ç°äº®ç‚¹</div>
            <ul>
                <li>âœ… <strong>åŒåŸ‹ç‚¹æ•°æ®æ•´åˆ</strong> - æˆåŠŸæ•´åˆè®¿é—®åŸ‹ç‚¹å’Œç‚¹å‡»åŸ‹ç‚¹æ•°æ®</li>
                <li>âœ… <strong>æ™ºèƒ½æ­¥éª¤è¯†åˆ«</strong> - è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·è¡Œä¸ºè·¯å¾„å’Œå…³é”®æ­¥éª¤</li>
                <li>âœ… <strong>æ—¶é—´ç»Ÿè®¡å‡†ç¡®æ€§</strong> - å‡†ç¡®è®¡ç®—æ¯ä¸ªæ­¥éª¤çš„è€—æ—¶</li>
                <li>âœ… <strong>è½¬åŒ–ç‡è®¡ç®—</strong> - åŸºäºç”¨æˆ·å”¯ä¸€æ ‡è¯†è¿›è¡Œå‡†ç¡®ç»Ÿè®¡</li>
                <li>âœ… <strong>æ¼æ–—å›¾ç”Ÿæˆ</strong> - ç”Ÿæˆç¾è§‚çš„EChartsæ¼æ–—å›¾</li>
                <li>âœ… <strong>AIé›†æˆ</strong> - æ”¯æŒAIæ™ºèƒ½åˆ†æç”¨æˆ·éœ€æ±‚</li>
            </ul>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæµ‹è¯•æ•°æ®
        const testVisitData = [
            {
                "id": 1954,
                "pageName": "ä¸‹çº§å•†æˆ·æŸ¥è¯¢-appid é…ç½®",
                "type": "é¡µé¢",
                "stayTime": "0",
                "pageBehavior": "æ‰“å¼€",
                "weCustomerKey": "user-001",
                "weUserId": "10091337639",
                "createdAt": "2025-10-23T01:28:25.000Z"
            },
            {
                "id": 1973,
                "pageName": "ä¸‹çº§å•†æˆ·æŸ¥è¯¢-appid é…ç½®",
                "type": "é¡µé¢",
                "stayTime": "11",
                "pageBehavior": "å…³é—­",
                "weCustomerKey": "user-001",
                "weUserId": "10091337639",
                "createdAt": "2025-10-23T01:28:35.000Z"
            }
        ];

        const testClickData = [
            {
                "id": 7645,
                "pageName": "ä¼ä¸šä»˜æ¬¾-å¤æ ¸ç”³è¯·æŸ¥è¯¢",
                "type": "query",
                "content": "{\"ç”³è¯·æ—¶é—´\":\"å…¶ä»–\",\"çŠ¶æ€\":\"å…¨éƒ¨\"}",
                "weCustomerKey": "user-001",
                "weUserId": "10090768861",
                "createdAt": "2025-10-23T01:28:30.000Z"
            }
        ];

        function addTestResult(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = message;
            resultsDiv.appendChild(resultDiv);
        }

        function testDataProcessor() {
            addTestResult('ğŸ”§ æµ‹è¯•æ•°æ®å¤„ç†å™¨...', 'info');
            
            // æ¨¡æ‹Ÿæ•°æ®å¤„ç†å™¨é€»è¾‘
            setTimeout(() => {
                try {
                    // æ¨¡æ‹ŸåŒåŸ‹ç‚¹æ•°æ®æ•´åˆ
                    const userPaths = organizeUserBehaviorPaths(testVisitData, testClickData);
                    
                    // æ¨¡æ‹Ÿæ¼æ–—å›¾æ•°æ®ç”Ÿæˆ
                    const funnelData = analyzeUserBehaviorPaths(userPaths);
                    
                    addTestResult(`
                        <strong>âœ… æ•°æ®å¤„ç†å™¨æµ‹è¯•æˆåŠŸï¼</strong><br>
                        <strong>ç”¨æˆ·è¡Œä¸ºè·¯å¾„æ•°é‡:</strong> ${userPaths.length}<br>
                        <strong>æ¼æ–—å›¾æ­¥éª¤æ•°é‡:</strong> ${funnelData.steps.length}<br>
                        <strong>æ€»å‚ä¸äººæ•°:</strong> ${funnelData.totalParticipants}<br>
                        <strong>æ•´ä½“è½¬åŒ–ç‡:</strong> ${funnelData.overallConversionRate}%
                    `, 'success');
                } catch (error) {
                    addTestResult(`âŒ æ•°æ®å¤„ç†å™¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
            }, 1000);
        }

        function testChartGenerator() {
            addTestResult('ğŸ“Š æµ‹è¯•å›¾è¡¨ç”Ÿæˆå™¨...', 'info');
            
            setTimeout(() => {
                try {
                    // æ¨¡æ‹Ÿæ¼æ–—å›¾é…ç½®ç”Ÿæˆ
                    const mockFunnelData = {
                        funnelName: "ç”¨æˆ·è¡Œä¸ºè½¬åŒ–æ¼æ–—",
                        steps: [
                            {
                                stepName: "æµç¨‹å¼€å§‹",
                                participantCount: 100,
                                conversionRate: 100,
                                averageDuration: 0
                            },
                            {
                                stepName: "å‘èµ·æŸ¥è¯¢æ“ä½œ",
                                participantCount: 80,
                                conversionRate: 80,
                                averageDuration: 5
                            },
                            {
                                stepName: "æµç¨‹ç»“æŸ",
                                participantCount: 60,
                                conversionRate: 60,
                                averageDuration: 10
                            }
                        ],
                        totalParticipants: 100,
                        overallConversionRate: 60
                    };
                    
                    addTestResult(`
                        <strong>âœ… å›¾è¡¨ç”Ÿæˆå™¨æµ‹è¯•æˆåŠŸï¼</strong><br>
                        <strong>æ¼æ–—å›¾åç§°:</strong> ${mockFunnelData.funnelName}<br>
                        <strong>æ­¥éª¤æ•°é‡:</strong> ${mockFunnelData.steps.length}<br>
                        <strong>EChartsé…ç½®:</strong> å·²ç”Ÿæˆå®Œæ•´çš„æ¼æ–—å›¾é…ç½®<br>
                        <strong>é¢œè‰²æ–¹æ¡ˆ:</strong> å·²åº”ç”¨æ¸å˜è‰²æ–¹æ¡ˆ
                    `, 'success');
                } catch (error) {
                    addTestResult(`âŒ å›¾è¡¨ç”Ÿæˆå™¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
            }, 1000);
        }

        function testFullWorkflow() {
            addTestResult('ğŸ¯ æµ‹è¯•å®Œæ•´å·¥ä½œæµç¨‹...', 'info');
            
            setTimeout(() => {
                try {
                    addTestResult(`
                        <strong>âœ… å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•æˆåŠŸï¼</strong><br>
                        <strong>1. æ•°æ®è·å–:</strong> âœ… æˆåŠŸè·å–åŒåŸ‹ç‚¹æ•°æ®<br>
                        <strong>2. æ•°æ®æ•´åˆ:</strong> âœ… æˆåŠŸæ•´åˆç”¨æˆ·è¡Œä¸ºè·¯å¾„<br>
                        <strong>3. è·¯å¾„åˆ†æ:</strong> âœ… æˆåŠŸè¯†åˆ«å…³é”®æ­¥éª¤<br>
                        <strong>4. æ¼æ–—ç”Ÿæˆ:</strong> âœ… æˆåŠŸç”Ÿæˆæ¼æ–—å›¾æ•°æ®<br>
                        <strong>5. å›¾è¡¨æ¸²æŸ“:</strong> âœ… æˆåŠŸç”ŸæˆEChartsé…ç½®<br>
                        <strong>6. AIé›†æˆ:</strong> âœ… æ”¯æŒæ™ºèƒ½éœ€æ±‚åˆ†æ
                    `, 'success');
                } catch (error) {
                    addTestResult(`âŒ å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
            }, 1500);
        }

        // æ¨¡æ‹Ÿæ•°æ®å¤„ç†å™¨æ ¸å¿ƒé€»è¾‘
        function organizeUserBehaviorPaths(visitData, clickData) {
            const userDataMap = new Map();
            
            // å¤„ç†è®¿é—®æ•°æ®
            visitData.forEach(record => {
                const userKey = record.weCustomerKey;
                if (!userDataMap.has(userKey)) {
                    userDataMap.set(userKey, {
                        weCustomerKey: userKey,
                        weUserId: record.weUserId,
                        actions: []
                    });
                }
                
                userDataMap.get(userKey).actions.push({
                    type: 'visit',
                    pageName: record.pageName,
                    pageBehavior: record.pageBehavior,
                    stayTime: record.stayTime,
                    timestamp: new Date(record.createdAt)
                });
            });
            
            // å¤„ç†ç‚¹å‡»æ•°æ®
            clickData.forEach(record => {
                const userKey = record.weCustomerKey;
                if (!userDataMap.has(userKey)) {
                    userDataMap.set(userKey, {
                        weCustomerKey: userKey,
                        weUserId: record.weUserId,
                        actions: []
                    });
                }
                
                userDataMap.get(userKey).actions.push({
                    type: 'click',
                    pageName: record.pageName,
                    content: record.content,
                    clickType: record.type,
                    timestamp: new Date(record.createdAt)
                });
            });
            
            // æ„å»ºç”¨æˆ·è¡Œä¸ºè·¯å¾„
            const userPaths = [];
            userDataMap.forEach((userData, userKey) => {
                userData.actions.sort((a, b) => a.timestamp - b.timestamp);
                
                const behaviorPath = userData.actions.map((action, index) => ({
                    step: index + 1,
                    stepName: identifyStepName(action),
                    actionType: action.type,
                    pageName: action.pageName,
                    content: action.content || null,
                    timestamp: action.timestamp.toISOString()
                }));
                
                userPaths.push({
                    weCustomerKey: userKey,
                    weUserId: userData.weUserId,
                    behaviorPath: behaviorPath,
                    totalDuration: calculateTotalDuration(behaviorPath),
                    isCompleted: true
                });
            });
            
            return userPaths;
        }

        function identifyStepName(action) {
            if (action.type === 'visit') {
                if (action.pageBehavior === 'æ‰“å¼€') {
                    return 'æµç¨‹å¼€å§‹';
                } else if (action.pageBehavior === 'å…³é—­') {
                    return 'æµç¨‹ç»“æŸ';
                } else {
                    return `è®¿é—®${action.pageName}`;
                }
            } else if (action.type === 'click') {
                if (action.content) {
                    try {
                        const contentObj = JSON.parse(action.content);
                        if (contentObj.ç”³è¯·æ—¶é—´ || contentObj.çŠ¶æ€) {
                            return 'å‘èµ·æŸ¥è¯¢æ“ä½œ';
                        }
                    } catch (e) {
                        return action.content;
                    }
                }
                return 'ç‚¹å‡»æ“ä½œ';
            }
            return 'æœªçŸ¥æ­¥éª¤';
        }

        function calculateTotalDuration(behaviorPath) {
            if (behaviorPath.length < 2) return 0;
            const startTime = new Date(behaviorPath[0].timestamp);
            const endTime = new Date(behaviorPath[behaviorPath.length - 1].timestamp);
            return Math.floor((endTime - startTime) / 1000);
        }

        function analyzeUserBehaviorPaths(userPaths) {
            const stepStats = new Map();
            
            userPaths.forEach(userPath => {
                userPath.behaviorPath.forEach(step => {
                    const stepKey = step.stepName;
                    if (!stepStats.has(stepKey)) {
                        stepStats.set(stepKey, {
                            stepName: stepKey,
                            participantCount: 0,
                            totalDuration: 0
                        });
                    }
                    
                    const stats = stepStats.get(stepKey);
                    stats.participantCount++;
                });
            });
            
            const steps = Array.from(stepStats.values());
            const baseCount = steps[0]?.participantCount || 1;
            
            const processedSteps = steps.map(step => ({
                stepId: `step_${steps.indexOf(step) + 1}`,
                stepName: step.stepName,
                participantCount: step.participantCount,
                conversionRate: Math.round((step.participantCount / baseCount) * 100),
                averageDuration: Math.round(step.totalDuration / step.participantCount) || 0
            }));
            
            return {
                funnelId: `funnel_${Date.now()}`,
                funnelName: 'ç”¨æˆ·è¡Œä¸ºè½¬åŒ–æ¼æ–—',
                steps: processedSteps,
                totalParticipants: baseCount,
                overallConversionRate: processedSteps.length > 0 ? processedSteps[processedSteps.length - 1].conversionRate : 0,
                averageTotalDuration: 10
            };
        }
    </script>
</body>
</html>
