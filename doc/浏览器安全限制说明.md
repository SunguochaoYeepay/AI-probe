# 浏览器安全限制说明

## 问题描述

在浏览器环境中进行跨域请求时，会遇到以下错误：
```
Refused to set unsafe header "origin"
Refused to set unsafe header "referer" 
Refused to set unsafe header "user-agent"
```

## 根本原因

这是浏览器的安全限制，某些请求头被认为是"不安全的"，不能通过 JavaScript 手动设置，包括：

### 禁止设置的请求头
- `origin` - 请求来源
- `referer` - 引用页面
- `user-agent` - 用户代理
- `host` - 主机名
- `content-length` - 内容长度
- `connection` - 连接类型
- `upgrade` - 协议升级
- `proxy-*` - 代理相关
- `sec-*` - 安全相关

### 允许设置的请求头
- `accept` - 接受的内容类型
- `accept-language` - 接受的语言
- `content-type` - 内容类型
- `authorization` - 授权信息
- `x-*` - 自定义请求头（通常）

## 解决方案

### 1. 移除不安全的请求头

**修改前**：
```javascript
const headers = {
  'accept': '*/*',
  'access-token': token,
  'content-type': 'text/plain;charset=UTF-8',
  'origin': 'https://probe.yeepay.com',           // ❌ 不安全
  'referer': 'https://probe.yeepay.com/page',     // ❌ 不安全
  'user-agent': 'Mozilla/5.0...'                  // ❌ 不安全
}
```

**修改后**：
```javascript
const headers = {
  'accept': '*/*',
  'access-token': token,
  'content-type': 'text/plain;charset=UTF-8'
  // ✅ 只保留安全的请求头
}
```

### 2. 使用自定义请求头

如果需要传递额外信息，可以使用自定义请求头：

```javascript
const headers = {
  'accept': '*/*',
  'access-token': token,
  'content-type': 'text/plain;charset=UTF-8',
  'x-request-source': 'web-app',        // ✅ 自定义请求头
  'x-client-version': '1.0.0'           // ✅ 自定义请求头
}
```

### 3. 服务器端处理

服务器端应该能够处理：
- 缺少某些请求头的情况
- 使用默认值或从其他来源获取信息

## 实际修复

### probeService.js 修复

**修复前**：
```javascript
getHeaders() {
  return {
    'accept': '*/*',
    'accept-language': 'en,zh-CN;q=0.9,zh;q=0.8',
    'access-token': this.token,
    'content-type': 'text/plain;charset=UTF-8',
    'origin': 'https://probe.yeepay.com',                    // ❌
    'referer': 'https://probe.yeepay.com/webfunny_event/',   // ❌
    'user-agent': 'Mozilla/5.0...'                          // ❌
  }
}
```

**修复后**：
```javascript
getHeaders() {
  return {
    'accept': '*/*',
    'accept-language': 'en,zh-CN;q=0.9,zh;q=0.8',
    'access-token': this.token,
    'content-type': 'text/plain;charset=UTF-8'
    // ✅ 移除了不安全的请求头
  }
}
```

## 影响分析

### 对功能的影响
- ✅ **无影响**：移除这些请求头不会影响 API 的核心功能
- ✅ **安全性提升**：符合浏览器安全规范
- ✅ **兼容性改善**：避免了浏览器警告和错误

### 对 API 调用的影响
- **origin**：浏览器会自动设置，无需手动设置
- **referer**：浏览器会自动设置，无需手动设置  
- **user-agent**：浏览器会自动设置，无需手动设置

## 最佳实践

### 1. 请求头设计原则
- 只设置必要的请求头
- 避免设置浏览器限制的请求头
- 使用自定义请求头传递额外信息

### 2. 错误处理
```javascript
try {
  const response = await fetch(url, { headers })
} catch (error) {
  if (error.message.includes('unsafe header')) {
    console.warn('检测到不安全的请求头，请检查请求配置')
  }
}
```

### 3. 开发调试
- 使用浏览器开发者工具检查实际发送的请求头
- 对比浏览器自动设置的请求头与手动设置的请求头
- 确保服务器能够正确处理请求

## 相关资源

- [MDN - 禁止的请求头](https://developer.mozilla.org/en-US/docs/Glossary/Forbidden_header_name)
- [Fetch API 规范](https://fetch.spec.whatwg.org/)
- [CORS 规范](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)

## 总结

移除不安全的请求头是浏览器安全机制的要求，不会影响 API 功能的正常使用。浏览器会自动设置必要的请求头，服务器端应该能够正确处理这些请求。
