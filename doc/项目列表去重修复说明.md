# 项目列表去重修复说明

## 问题描述

在项目配置界面中出现 Vue 警告：
```
[Vue warn]: Duplicate keys found during update: "webfunny_20221129_175113" 
Make sure keys are unique.
```

## 根本原因

API 返回的团队列表中，多个团队可能包含相同的项目ID，导致：
1. 项目列表中出现重复的项目ID
2. Vue 渲染列表时发现重复的 key
3. 造成控制台警告和潜在的渲染问题

## 修复方案

### 1. 使用 Map 数据结构去重

**修复前**：
```javascript
const projects = []
data.forEach(team => {
  const projectIds = team.webMonitorIds.split(',')
  projectIds.forEach(projectId => {
    projects.push({
      id: projectId.trim(),
      name: `${team.teamName} - ${projectId.trim()}`,
      teamName: team.teamName,
      teamId: team.id
    })
  })
})
```

**修复后**：
```javascript
const projectsMap = new Map() // 使用 Map 来去重
data.forEach(team => {
  const projectIds = team.webMonitorIds.split(',')
  projectIds.forEach(projectId => {
    const trimmedId = projectId.trim()
    if (!projectsMap.has(trimmedId)) {
      // 首次出现的项目ID
      projectsMap.set(trimmedId, {
        id: trimmedId,
        name: `${team.teamName} - ${trimmedId}`,
        teamName: team.teamName,
        teamId: team.id
      })
    } else {
      // 项目ID已存在，合并团队信息
      const existingProject = projectsMap.get(trimmedId)
      if (!existingProject.name.includes(team.teamName)) {
        existingProject.name = `${existingProject.name}, ${team.teamName}`
      }
    }
  })
})
```

### 2. 智能合并重复项目

当发现重复的项目ID时：
- **保留第一个项目**：使用第一个团队的信息作为主要信息
- **合并团队信息**：将后续团队名称追加到项目名称中
- **确保唯一性**：每个项目ID只出现一次

### 3. 数据排序优化

```javascript
const projects = Array.from(projectsMap.values()).sort((a, b) => {
  // 先按团队名称排序，再按项目ID排序
  if (a.teamName !== b.teamName) {
    return a.teamName.localeCompare(b.teamName)
  }
  return a.id.localeCompare(b.id)
})
```

## 修复效果

### 1. 消除重复键警告
- ✅ 每个项目ID在列表中只出现一次
- ✅ Vue 渲染时不再出现重复 key 警告
- ✅ 控制台警告消失

### 2. 数据完整性保持
- ✅ 保留所有项目信息
- ✅ 显示项目所属的多个团队
- ✅ 数据排序更加合理

### 3. 用户体验提升
- ✅ 项目列表更加清晰
- ✅ 避免用户困惑（为什么同一个项目出现多次）
- ✅ 项目选择更加直观

## 示例对比

### 修复前（有重复）
```javascript
[
  { id: "webfunny_20221129_175113", name: "团队A - webfunny_20221129_175113", teamName: "团队A" },
  { id: "webfunny_20221129_175113", name: "团队B - webfunny_20221129_175113", teamName: "团队B" }, // ❌ 重复
  { id: "event1021", name: "团队A - event1021", teamName: "团队A" }
]
```

### 修复后（已去重）
```javascript
[
  { id: "event1021", name: "团队A - event1021", teamName: "团队A" },
  { id: "webfunny_20221129_175113", name: "团队A - webfunny_20221129_175113, 团队B", teamName: "团队A" } // ✅ 合并
]
```

## 技术细节

### 1. Map 数据结构优势
- **O(1) 查找时间**：快速检查项目ID是否已存在
- **自动去重**：相同的 key 只会保留一个值
- **保持顺序**：Map 保持插入顺序

### 2. 字符串处理
- **trim()**：去除项目ID的前后空格
- **includes()**：检查团队名称是否已包含在项目名称中
- **localeCompare()**：支持中文排序

### 3. 错误处理
- **空数据处理**：当 API 返回空数据时提供默认项目
- **格式验证**：检查数据格式是否符合预期
- **日志记录**：记录处理过程和结果

## 相关文件

### 修改的文件
- `src/api/probeService.js` - 主要修复文件

### 影响范围
- 项目配置界面的项目选择器
- 项目列表的显示和排序
- Vue 组件的渲染性能

## 测试验证

### 1. 功能测试
- ✅ 项目列表正常显示
- ✅ 重复项目已去重
- ✅ 项目选择功能正常

### 2. 性能测试
- ✅ 无 Vue 警告信息
- ✅ 渲染性能正常
- ✅ 内存使用合理

### 3. 用户体验测试
- ✅ 项目列表清晰易读
- ✅ 项目选择操作流畅
- ✅ 界面响应正常

## 总结

通过使用 Map 数据结构进行去重处理，我们成功地：

- ✅ **解决了 Vue 重复 key 警告**
- ✅ **保持了数据的完整性**
- ✅ **提升了用户体验**
- ✅ **优化了数据排序**

现在项目配置界面可以正常显示项目列表，不会再出现重复键的警告信息。
