# 图表持久化功能使用说明

## ✨ 功能概述

系统现在支持**图表持久化和自动更新**功能，可以将生成的图表保存到本地数据库，并每天自动更新数据。

### 核心特性

- ✅ **图表保存**：一键保存AI生成的图表配置和历史数据
- ✅ **自动更新**：每天自动获取并聚合最新数据
- ✅ **无限历史**：历史数据持续累积，支持长期趋势分析
- ✅ **秒级加载**：聚合后的数据加载速度极快
- ✅ **本地存储**：使用IndexedDB，数据永久保存在浏览器

---

## 📖 使用指南

### 1. 创建并保存图表

#### 步骤1：输入分析需求

在首页输入分析需求，例如：
```
支付页面最近7天的UV/PV趋势
```

#### 步骤2：智能分析

点击"智能分析"按钮，系统会：
1. 解析需求
2. 获取数据（可能需要几秒）
3. 生成图表

#### 步骤3：保存图表

图表生成后，点击右上角的**"保存图表"**按钮：
- 系统会自动聚合数据（30万条 → 几百条）
- 保存图表配置和历史数据到IndexedDB
- 弹出提示，可以点击查看

---

### 2. 查看图表列表

#### 访问图表库

点击导航菜单或直接访问 `/my-charts`，可以看到：

**统计面板**
- 图表总数
- 激活图表数量
- 数据总量
- 平均数据量

**分类标签**
- 全部
- 页面分析
- 用户行为
- 转化分析
- 全局概览

**图表卡片**
- 图表名称和描述
- 分类和状态标签
- 创建时间和更新时间
- 快捷操作（查看/更新/删除）

---

### 3. 查看图表详情

点击任意图表卡片，进入详情页面：

#### 信息栏
- 图表配置信息
- 最后更新时间
- 数据范围和数据量
- 更新状态提示

#### 图表区域
- 交互式ECharts图表
- 完整的历史数据展示
- 响应式设计

#### 关键指标
- UV、PV等核心指标
- 最新一天的数据统计

#### 数据明细
- 表格形式展示每天的数据
- 支持分页和排序
- 可导出CSV

#### 操作按钮
- **刷新数据**：手动获取最新数据
- **导出**：导出图表为PNG图片
- **删除**：删除图表（含历史数据）

---

### 4. 自动更新机制

系统会在以下时机自动检查和更新数据：

#### 应用启动时
```
打开应用 → 初始化图表管理器 → 检查昨天的数据 → 自动更新
```

#### 更新逻辑
1. 检查所有激活的图表
2. 判断昨天的数据是否存在
3. 如果不存在，自动获取并聚合
4. 更新到IndexedDB

#### 优化策略
- **按项目分组**：相同项目的图表共享原始数据
- **批量更新**：一次API调用更新多个图表
- **后台处理**：不阻塞用户操作

**示例**：
```
10个图表，3个不同项目
→ 只需3次API调用
→ 每个3万条数据聚合为1条
→ 总耗时约5-10秒
```

---

## 🔧 技术细节

### 数据存储结构

#### IndexedDB数据库
- **数据库名**：`yeepay_charts_db`
- **版本**：1

#### 三个表
1. **charts**：图表配置表
2. **chart_data**：聚合数据表
3. **raw_data_cache**：原始数据缓存（可选）

### 聚合策略

#### 原始数据 → 聚合数据

**示例：单天3万条数据聚合**
```javascript
输入：30000条原始数据（某一天）
过滤：只保留"支付页面"的数据 → 1000条
聚合：
  {
    date: "2025-10-11",
    metrics: {
      uv: 500,  // 去重后的独立用户数
      pv: 1000  // 页面访问次数
    }
  }
输出：1条聚合数据
```

**存储优势**
- 原始数据：30万条 × 2KB = 600MB
- 聚合数据：100条 × 1KB = 100KB
- **压缩比：6000:1**

### 性能指标

| 操作 | 首次 | 后续 | 说明 |
|------|------|------|------|
| 创建图表 | 5-10秒 | - | 获取+聚合+保存 |
| 查看图表列表 | <500ms | <500ms | 从IndexedDB加载 |
| 查看图表详情 | <1秒 | <1秒 | 从IndexedDB加载 |
| 每日更新单图表 | 3-5秒 | 3-5秒 | 获取+聚合+保存 |
| 批量更新10图表 | 10-30秒 | 10-30秒 | 按项目优化 |

---

## 💡 使用技巧

### 1. 合理命名图表

保存图表时，系统会自动使用需求描述作为图表名称：
```
好的命名：
✓ 支付页面UV/PV趋势
✓ 首页转化漏斗分析
✓ TOP10热门页面

不好的命名：
✗ 页面分析
✗ 数据统计
✗ 图表1
```

### 2. 按分类管理

创建图表时，系统会根据图表类型自动分类：
- 趋势图、柱状图 → 页面分析
- 漏斗图 → 转化分析
- 点击热力图 → 用户行为

### 3. 定期清理

如果图表过多，可以：
- 暂停不常用的图表（设置status为paused）
- 删除过时的图表
- 导出重要数据后归档

### 4. 数据对比

利用累积的历史数据，可以进行：
- 同比分析（今年vs去年）
- 环比分析（本月vs上月）
- 趋势预测（基于历史数据）

---

## ❓ 常见问题

### Q1: 图表数据多久更新一次？

**A:** 每天自动更新一次，更新昨天的数据。你也可以手动点击"刷新数据"按钮立即更新。

### Q2: 历史数据会保留多久？

**A:** 无限期保留。所有历史数据都存储在浏览器的IndexedDB中，除非你手动删除。

### Q3: 数据会占用多少空间？

**A:** 非常少！经过聚合后：
- 单个图表365天数据 ≈ 365KB
- 50个图表365天数据 ≈ 18MB

### Q4: 如果清除浏览器数据会怎样？

**A:** 清除浏览器数据会删除IndexedDB，所有保存的图表和历史数据会丢失。建议定期导出重要数据。

### Q5: 可以在不同浏览器中查看相同的图表吗？

**A:** 不可以。IndexedDB是浏览器本地存储，数据不会跨浏览器同步。将来迁移到CS架构（Electron）后可以支持。

### Q6: 更新失败了怎么办？

**A:** 可以手动点击"刷新数据"重试。如果持续失败，检查：
1. API配置是否正确
2. 网络连接是否正常
3. 浏览器控制台是否有错误信息

### Q7: 30万条数据真的能处理吗？

**A:** 可以！系统采用**边获取边聚合**的策略：
- 按天获取（每次3万条）
- 立即聚合为1条
- 丢弃原始数据，释放内存
- 最终只保存100-300条聚合数据

---

## 🚀 后续规划

### 短期（1-2周）
- [ ] HyperLogLog精确UV去重
- [ ] 原始数据缓存（最近3天）
- [ ] 数据对比功能（同比/环比）

### 中期（1-2月）
- [ ] Electron桌面应用
- [ ] 真正的定时任务（Cron）
- [ ] 离线能力

### 长期
- [ ] 多图表联动
- [ ] 自定义计算指标
- [ ] 团队协作和分享

---

## 📞 反馈与支持

如果你在使用过程中遇到问题或有改进建议，请：
1. 查看浏览器控制台的日志
2. 记录操作步骤和错误信息
3. 联系开发团队

---

**版本**：v1.0  
**更新时间**：2025-10-11  
**文档维护**：开发团队

