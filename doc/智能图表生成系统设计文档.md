# 智能图表生成系统设计文档

## 1. 项目概述

### 1.1 项目背景
基于用户自然语言需求，自动生成数据可视化图表的智能系统。用户只需提供基本配置信息和描述需求，系统即可自动理解意图并生成相应的图表。

### 1.2 核心价值
- **智能化**：基于AI的需求理解和图表生成
- **自动化**：无需手动选择图表类型，系统智能决策
- **灵活性**：支持各种分析场景和图表类型
- **易用性**：降低用户使用门槛，提升分析效率

## 2. 系统架构

### 2.1 整体架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户输入层     │    │   AI理解层      │    │  智能生成层     │
│                │    │                │    │                │
│ • API配置       │───▶│ • 需求解析      │───▶│ • 图表类型选择  │
│ • 数据源设置     │    │ • 意图识别      │    │ • 数据映射      │
│ • 需求描述       │    │ • 参数提取      │    │ • 配置生成      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                        │
┌─────────────────┐    ┌─────────────────┐              │
│   渲染展示层     │◀───│   数据适配层     │◀─────────────┘
│                │    │                │
│ • 图表渲染       │    │ • 数据清洗      │
│ • 交互功能       │    │ • 格式转换      │
│ • 样式适配       │    │ • 统计分析      │
└─────────────────┘    └─────────────────┘
```

### 2.2 核心模块

#### 2.2.1 用户输入层
- **需求描述模块**：自然语言需求输入
- **数据源管理**：支持多种数据源接入

#### 2.2.1.1 API配置管理模块（独立模块）
- **配置存储**：项目ID、埋点ID、默认查询日期、访问令牌等预设配置
- **配置管理**：支持配置的增删改查，支持多环境配置
- **自动配置**：系统自动应用预设配置，用户无需手动设置
- **配置验证**：自动验证配置有效性，提供配置建议

#### 2.2.2 AI理解层
- **需求解析引擎**：自然语言处理和语义分析
- **意图识别器**：识别用户分析意图
- **参数提取器**：从需求中提取关键参数

#### 2.2.3 智能生成层
- **图表类型选择器**：根据需求智能选择图表类型
- **数据映射器**：将原始数据转换为图表所需格式
- **配置生成器**：自动生成图表配置参数

#### 2.2.4 数据适配层
- **数据清洗器**：数据预处理和清洗
- **格式转换器**：数据格式标准化
- **统计分析器**：基础统计计算

#### 2.2.5 渲染展示层
- **图表渲染引擎**：基于ECharts的动态渲染
- **交互控制器**：图表交互功能
- **样式管理器**：主题和样式适配

## 3. 需求理解引擎设计

### 3.1 关键词映射表
```javascript
const requirementMapping = {
    // 漏斗分析类
    funnel: {
        keywords: ['转化', '漏斗', '流程', '步骤', '转化率', '流失'],
        chartType: 'funnel',
        description: '展示用户在各步骤的转化情况'
    },
    
    // 趋势分析类
    trend: {
        keywords: ['趋势', '变化', '时间', '历史', '走势', '增长', '下降'],
        chartType: 'line',
        description: '展示数据随时间的变化趋势'
    },
    
    // 对比分析类
    comparison: {
        keywords: ['对比', '比较', '差异', '排名', '高低', '大小'],
        chartType: 'bar',
        description: '展示不同维度的数据对比'
    },
    
    // 分布分析类
    distribution: {
        keywords: ['分布', '占比', '比例', '构成', '组成'],
        chartType: 'pie',
        description: '展示数据的分布情况'
    },
    
    // 概览分析类
    overview: {
        keywords: ['总体', '概览', '汇总', '统计', '总数', '平均'],
        chartType: 'value_card',
        description: '展示关键指标的总体情况'
    },
    
    // 成功失败分析
    success_failure: {
        keywords: ['成功', '失败', '通过', '不通过', '完成', '未完成'],
        chartType: 'stacked_bar',
        description: '展示成功失败对比情况'
    }
};
```

### 3.2 需求解析算法
```javascript
function parseUserRequirement(requirement) {
    const analysis = {
        intent: null,
        chartType: null,
        parameters: {},
        confidence: 0
    };
    
    // 1. 关键词匹配
    const matchedCategories = [];
    Object.keys(requirementMapping).forEach(category => {
        const mapping = requirementMapping[category];
        const matchCount = mapping.keywords.filter(keyword => 
            requirement.includes(keyword)
        ).length;
        
        if (matchCount > 0) {
            matchedCategories.push({
                category,
                score: matchCount / mapping.keywords.length,
                mapping
            });
        }
    });
    
    // 2. 选择最佳匹配
    if (matchedCategories.length > 0) {
        const bestMatch = matchedCategories.sort((a, b) => b.score - a.score)[0];
        analysis.intent = bestMatch.category;
        analysis.chartType = bestMatch.mapping.chartType;
        analysis.confidence = bestMatch.score;
    }
    
    // 3. 参数提取
    analysis.parameters = extractParameters(requirement);
    
    return analysis;
}
```

## 4. 智能图表生成器设计

### 4.1 图表类型选择策略
```javascript
function selectChartType(analysis, data) {
    const strategies = {
        // 基于数据特征的选择
        dataDriven: (data) => {
            if (data.length > 100) return 'trend';
            if (data.length < 10) return 'value_card';
            return 'bar';
        },
        
        // 基于需求的选择
        requirementDriven: (analysis) => {
            return analysis.chartType || 'bar';
        },
        
        // 混合策略
        hybrid: (analysis, data) => {
            const reqType = analysis.chartType;
            const dataType = dataDriven(data);
            
            // 如果需求明确，优先使用需求类型
            if (analysis.confidence > 0.7) {
                return reqType;
            }
            
            // 否则根据数据特征选择
            return dataType;
        }
    };
    
    return strategies.hybrid(analysis, data);
}
```

### 4.2 动态配置生成
```javascript
function generateChartConfig(analysis, data, chartType) {
    const baseConfig = {
        title: generateTitle(analysis),
        tooltip: generateTooltip(chartType),
        legend: generateLegend(data),
        series: generateSeries(data, chartType),
        xAxis: generateXAxis(data, chartType),
        yAxis: generateYAxis(data, chartType)
    };
    
    // 根据图表类型添加特定配置
    const typeSpecificConfig = getTypeSpecificConfig(chartType, data);
    
    return { ...baseConfig, ...typeSpecificConfig };
}
```

## 5. 用户界面设计

### 5.1 界面布局
```
┌─────────────────────────────────────────────────────────┐
│                    智能图表生成系统                        │
├─────────────────────────────────────────────────────────┤
│  系统状态区域                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 📊 数据源：已连接 | 🔧 配置：已加载 | 📅 日期：今天   │ │
│  │ [配置管理] [数据刷新] [系统设置]                    │ │
│  └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  需求描述区域                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 请描述您想要的分析需求：                              │ │
│  │ [我想看转化率趋势] [我想对比各步骤的成功失败情况]      │ │
│  └─────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ AI理解结果：                                         │ │
│  │ 意图：趋势分析 | 图表类型：折线图 | 置信度：85%        │ │
│  └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  图表展示区域                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │                                                     │ │
│  │               [动态生成的图表]                       │ │
│  │                                                     │ │
│  └─────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ [重新生成] [微调配置] [导出图表] [保存配置]          │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 5.2 交互流程
1. **系统初始化**：自动加载预设API配置，验证数据源连接
2. **描述需求**：用户用自然语言描述分析需求
3. **AI理解**：系统解析需求并显示理解结果
4. **生成图表**：系统自动生成对应图表
5. **交互调整**：用户可重新生成或微调配置
6. **配置管理**：管理员可通过配置管理模块维护API配置

## 6. API配置管理模块详细设计

### 6.1 模块架构
```
┌─────────────────────────────────────────────────────────┐
│                API配置管理模块                            │
├─────────────────────────────────────────────────────────┤
│  配置存储层                                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │ 本地存储    │ │ 环境变量    │ │ 配置文件    │        │
│  └─────────────┘ └─────────────┘ └─────────────┘        │
├─────────────────────────────────────────────────────────┤
│  配置管理层                                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │ 配置加载    │ │ 配置验证    │ │ 配置更新    │        │
│  └─────────────┘ └─────────────┘ └─────────────┘        │
├─────────────────────────────────────────────────────────┤
│  配置应用层                                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │ 自动应用    │ │ 环境切换    │ │ 配置继承    │        │
│  └─────────────┘ └─────────────┘ └─────────────┘        │
└─────────────────────────────────────────────────────────┘
```

### 6.2 配置结构设计
```javascript
const apiConfig = {
    // 环境配置
    environments: {
        development: {
            projectId: "event1021",
            selectedPointId: 110,
            baseUrl: "https://dev-api.yeepay.com",
            accessToken: "dev_token_xxx",
            defaultDate: "2025-01-10",
            pageSize: 30
        },
        production: {
            projectId: "event1021",
            selectedPointId: 110,
            baseUrl: "https://probe.yeepay.com",
            accessToken: "prod_token_xxx",
            defaultDate: "today",
            pageSize: 100
        }
    },
    
    // 默认配置
    defaults: {
        currentEnvironment: "development",
        autoRefresh: true,
        refreshInterval: 30000,
        timeout: 10000
    },
    
    // 数据源配置
    dataSources: {
        primary: {
            type: "yeepay_api",
            endpoint: "/tracker/buryPointTest/search",
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Accept": "*/*"
            }
        }
    }
};
```

### 6.3 配置管理功能
```javascript
class APIConfigManager {
    constructor() {
        this.config = null;
        this.currentEnv = 'development';
    }
    
    // 加载配置
    async loadConfig() {
        // 1. 从本地存储加载
        const localConfig = this.loadFromLocalStorage();
        
        // 2. 从环境变量加载
        const envConfig = this.loadFromEnvironment();
        
        // 3. 合并配置
        this.config = this.mergeConfigs(localConfig, envConfig);
        
        // 4. 验证配置
        this.validateConfig();
        
        return this.config;
    }
    
    // 自动应用配置
    applyConfig() {
        if (!this.config) {
            throw new Error('配置未加载');
        }
        
        const envConfig = this.config.environments[this.currentEnv];
        
        // 自动设置API参数
        this.setAPIParams(envConfig);
        
        // 验证连接
        return this.validateConnection();
    }
    
    // 配置验证
    validateConfig() {
        const required = ['projectId', 'selectedPointId', 'baseUrl'];
        const envConfig = this.config.environments[this.currentEnv];
        
        required.forEach(field => {
            if (!envConfig[field]) {
                throw new Error(`缺少必要配置: ${field}`);
            }
        });
    }
    
    // 环境切换
    switchEnvironment(env) {
        if (!this.config.environments[env]) {
            throw new Error(`环境不存在: ${env}`);
        }
        
        this.currentEnv = env;
        this.applyConfig();
    }
}
```

### 6.4 配置管理界面
```
┌─────────────────────────────────────────────────────────┐
│                    API配置管理                           │
├─────────────────────────────────────────────────────────┤
│  环境选择                                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │ [开发环境]  │ │ [测试环境]  │ │ [生产环境]  │        │
│  └─────────────┘ └─────────────┘ └─────────────┘        │
├─────────────────────────────────────────────────────────┤
│  当前配置                                                │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 项目ID: event1021                                   │ │
│  │ 埋点ID: 110                                         │ │
│  │ 基础URL: https://probe.yeepay.com                   │ │
│  │ 访问令牌: **********                                │ │
│  │ 默认日期: 今天                                      │ │
│  │ 页面大小: 30                                        │ │
│  └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  连接状态                                                │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 🟢 连接正常 | 响应时间: 245ms | 最后更新: 刚刚      │ │
│  │ [测试连接] [刷新配置] [导出配置]                    │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 6.5 配置安全设计
- **令牌加密**：访问令牌本地加密存储
- **环境隔离**：不同环境配置完全隔离
- **权限控制**：配置修改需要管理员权限
- **审计日志**：记录配置变更历史

## 7. 技术实现方案

### 7.1 前端技术栈
- **框架**：原生JavaScript + HTML5 + CSS3
- **图表库**：ECharts 5.x
- **UI组件**：自定义组件库
- **状态管理**：简单状态管理

### 7.2 核心算法实现
```javascript
class IntelligentChartGenerator {
    constructor() {
        this.requirementParser = new RequirementParser();
        this.chartSelector = new ChartSelector();
        this.configGenerator = new ConfigGenerator();
        this.dataProcessor = new DataProcessor();
    }
    
    async generateChart(requirement, data) {
        // 1. 解析需求
        const analysis = this.requirementParser.parse(requirement);
        
        // 2. 选择图表类型
        const chartType = this.chartSelector.select(analysis, data);
        
        // 3. 处理数据
        const processedData = this.dataProcessor.process(data, chartType);
        
        // 4. 生成配置
        const config = this.configGenerator.generate(analysis, processedData, chartType);
        
        // 5. 渲染图表
        return this.renderChart(config);
    }
}
```

### 7.3 数据流处理
```javascript
// 数据适配流程
Raw Data → Data Cleaning → Format Conversion → Statistical Analysis → Chart Data

// 配置生成流程
User Requirement → Intent Analysis → Chart Type Selection → Config Generation → Chart Rendering
```

## 8. 扩展性设计

### 8.1 图表类型扩展
- 支持新增图表类型
- 插件化图表配置
- 自定义图表模板

### 8.2 需求理解扩展
- 支持更复杂的自然语言
- 多语言支持
- 上下文理解

### 8.3 数据源扩展
- 支持多种数据格式
- 实时数据接入
- 大数据量处理

## 9. 性能优化

### 9.1 前端优化
- 图表懒加载
- 数据分页处理
- 缓存机制

### 9.2 算法优化
- 需求解析缓存
- 图表配置模板
- 增量更新

## 10. 测试策略

### 10.1 单元测试
- 需求解析算法测试
- 图表配置生成测试
- 数据转换测试

### 10.2 集成测试
- 端到端流程测试
- 不同数据源测试
- 各种需求场景测试

### 10.3 用户体验测试
- 需求理解准确性测试
- 图表生成质量测试
- 交互体验测试

## 11. 部署方案

### 11.1 开发环境
- 本地开发服务器
- 热重载支持
- 调试工具集成

### 11.2 生产环境
- 静态文件部署
- CDN加速
- 监控告警

## 12. 未来规划

### 12.1 短期目标（1-3个月）
- 完成基础需求理解引擎
- 实现核心图表类型支持
- 优化用户界面体验

### 12.2 中期目标（3-6个月）
- 增强需求理解能力
- 支持更多图表类型
- 添加高级分析功能

### 12.3 长期目标（6-12个月）
- 集成机器学习模型
- 支持语音输入
- 智能推荐系统

---

**文档版本**：v1.0  
**创建日期**：2025-01-10  
**最后更新**：2025-01-10  
**作者**：AI Assistant
