# 用户行为分析漏斗图设计文档

## 1. 需求分析

### 1.1 功能需求
基于用户提供的截图，需要实现一个复杂的用户行为分析漏斗图，具备以下特征：

- **流程步骤展示**：显示用户行为的关键步骤
- **数据统计**：每个步骤的参与人数和转化率
- **时间信息**：每个步骤的耗时统计
- **可视化效果**：漏斗图形式展示转化过程

### 1.2 具体示例
从截图可以看到的漏斗图结构：
```
漏斗图_成功率与转化时长

左侧流程步骤：
- 第一步：流程开始 (15分钟)
- 第二步：发起余额分账 (15分钟)  
- 第二步：完成分账 (5分钟)

右侧数据展示：
- 流程开始：500 (100%)
- 发起余额分账：100 (20%)
- 完成分账：100 (10%)
```

### 1.3 核心功能点
1. **用户行为路径分析**：追踪用户在应用中的行为序列
2. **转化率计算**：计算每个步骤相对于起始步骤的转化率
3. **时间统计**：统计每个步骤的平均耗时
4. **智能识别**：AI自动识别用户行为流程
5. **自定义配置**：支持用户自定义流程步骤

## 2. 系统架构设计

### 2.1 整体架构
```
用户输入需求 → AI需求解析 → 数据获取 → 行为分析 → 漏斗图生成 → 可视化展示
```

### 2.2 核心组件

#### 2.2.1 数据处理器层
- **BehaviorAnalysisDataProcessor**：用户行为分析数据处理器
- **FunnelDataProcessor**：漏斗图数据处理器
- **TimeAnalysisProcessor**：时间分析处理器

#### 2.2.2 图表生成层
- **BehaviorFunnelGenerator**：行为漏斗图生成器
- **ConversionFunnelGenerator**：转化漏斗图生成器
- **TimeFunnelGenerator**：时间漏斗图生成器

#### 2.2.3 AI分析层
- **BehaviorRequirementParser**：行为需求解析器
- **FlowStepExtractor**：流程步骤提取器
- **ConversionAnalyzer**：转化分析器

## 3. 数据模型设计

### 3.1 用户行为数据模型
```javascript
// 用户行为记录
{
  id: "unique_id",
  userId: "user_123",
  sessionId: "session_456", 
  pageName: "页面名称",
  action: "行为类型", // visit, click, submit, etc.
  content: "具体内容",
  timestamp: "2025-01-01T10:00:00Z",
  duration: 15000, // 毫秒
  metadata: {
    // 额外的元数据
  }
}
```

### 3.2 流程步骤数据模型
```javascript
// 流程步骤定义
{
  stepId: "step_1",
  stepName: "流程开始",
  stepType: "entry", // entry, process, exit
  expectedDuration: 15, // 分钟
  description: "用户进入流程的起始步骤"
}
```

### 3.3 漏斗图数据模型
```javascript
// 漏斗图数据
{
  funnelId: "funnel_123",
  funnelName: "余额分账流程",
  steps: [
    {
      stepId: "step_1",
      stepName: "流程开始",
      participantCount: 500,
      conversionRate: 100, // 相对于起始步骤的百分比
      averageDuration: 15, // 分钟
      timeRange: "2025-01-01 到 2025-01-07"
    },
    {
      stepId: "step_2", 
      stepName: "发起余额分账",
      participantCount: 100,
      conversionRate: 20,
      averageDuration: 15,
      timeRange: "2025-01-01 到 2025-01-07"
    },
    {
      stepId: "step_3",
      stepName: "完成分账", 
      participantCount: 100,
      conversionRate: 10,
      averageDuration: 5,
      timeRange: "2025-01-01 到 2025-01-07"
    }
  ],
  totalParticipants: 500,
  overallConversionRate: 10,
  averageTotalDuration: 35 // 分钟
}
```

## 4. 核心算法设计

### 4.1 用户行为路径分析算法
```javascript
class BehaviorPathAnalyzer {
  // 分析用户行为路径
  analyzeUserPath(userActions) {
    // 1. 按时间排序用户行为
    // 2. 识别关键行为节点
    // 3. 计算步骤间的时间间隔
    // 4. 统计每个步骤的参与人数
  }
  
  // 识别流程步骤
  identifyFlowSteps(actions) {
    // 1. 使用AI识别关键步骤
    // 2. 基于行为模式匹配
    // 3. 支持自定义步骤定义
  }
}
```

### 4.2 转化率计算算法
```javascript
class ConversionRateCalculator {
  // 计算转化率
  calculateConversionRate(stepData) {
    const baseCount = stepData[0].participantCount;
    return stepData.map(step => ({
      ...step,
      conversionRate: (step.participantCount / baseCount) * 100
    }));
  }
  
  // 计算步骤间转化率
  calculateStepConversionRate(currentStep, previousStep) {
    return (currentStep.participantCount / previousStep.participantCount) * 100;
  }
}
```

### 4.3 时间分析算法
```javascript
class TimeAnalyzer {
  // 计算平均耗时
  calculateAverageDuration(actions, stepDefinition) {
    // 1. 识别步骤开始和结束时间
    // 2. 计算每个用户的步骤耗时
    // 3. 计算平均耗时
  }
  
  // 分析时间分布
  analyzeTimeDistribution(durations) {
    // 1. 计算中位数、四分位数
    // 2. 识别异常值
    // 3. 生成时间分布统计
  }
}
```

## 5. AI集成设计

### 5.1 需求解析提示词
```javascript
const BEHAVIOR_ANALYSIS_PROMPT = `
你是一个用户行为分析专家。请分析用户的需求，识别用户想要分析的行为流程。

用户需求："{userRequirement}"

请返回JSON格式的分析结果：
{
  "intent": "behavior_funnel_analysis",
  "chartType": "behavior_funnel",
  "description": "用户行为转化漏斗分析",
  "flowSteps": [
    {
      "stepName": "步骤名称",
      "stepType": "entry|process|exit",
      "keywords": ["关键词1", "关键词2"],
      "expectedDuration": 15
    }
  ],
  "confidence": 0.95
}
`;
```

### 5.2 流程步骤识别
```javascript
const FLOW_STEP_EXTRACTION_PROMPT = `
基于用户行为数据，识别关键的业务流程步骤。

行为数据：{behaviorData}

请识别出完整的业务流程，包括：
1. 流程起始步骤
2. 中间处理步骤  
3. 流程结束步骤

返回JSON格式：
{
  "flowName": "流程名称",
  "steps": [
    {
      "stepName": "步骤名称",
      "stepOrder": 1,
      "triggerActions": ["action1", "action2"],
      "pageNames": ["page1", "page2"]
    }
  ]
}
`;
```

## 6. 图表生成设计

### 6.1 漏斗图配置
```javascript
const generateBehaviorFunnelOption = (funnelData) => {
  return {
    title: {
      text: funnelData.funnelName,
      subtext: `总参与人数: ${funnelData.totalParticipants} | 整体转化率: ${funnelData.overallConversionRate}%`,
      left: 'center'
    },
    tooltip: {
      trigger: 'item',
      formatter: function(params) {
        const step = funnelData.steps[params.dataIndex];
        return `
          <strong>${step.stepName}</strong><br/>
          参与人数: ${step.participantCount}<br/>
          转化率: ${step.conversionRate}%<br/>
          平均耗时: ${step.averageDuration}分钟
        `;
      }
    },
    series: [{
      name: '行为转化漏斗',
      type: 'funnel',
      left: '10%',
      top: 60,
      bottom: 60,
      width: '80%',
      min: 0,
      max: funnelData.totalParticipants,
      minSize: '0%',
      maxSize: '100%',
      sort: 'descending',
      gap: 2,
      label: {
        show: true,
        position: 'inside',
        formatter: function(params) {
          const step = funnelData.steps[params.dataIndex];
          return `${step.stepName}\n${step.participantCount} (${step.conversionRate}%)`;
        }
      },
      labelLine: {
        length: 10,
        lineStyle: {
          width: 1,
          type: 'solid'
        }
      },
      itemStyle: {
        borderColor: '#fff',
        borderWidth: 1
      },
      emphasis: {
        label: {
          fontSize: 20
        }
      },
      data: funnelData.steps.map(step => ({
        value: step.participantCount,
        name: step.stepName,
        itemStyle: {
          color: getStepColor(step.stepOrder)
        }
      }))
    }]
  };
};
```

### 6.2 时间信息展示
```javascript
const addTimeInfoToFunnel = (option, funnelData) => {
  // 在漏斗图右侧添加时间信息
  option.graphic = funnelData.steps.map((step, index) => ({
    type: 'text',
    left: '85%',
    top: `${60 + (index * 20)}%`,
    style: {
      text: `${step.averageDuration}分钟`,
      fontSize: 12,
      fill: '#666'
    }
  }));
  
  return option;
};
```

## 7. 用户界面设计

### 7.1 行为分析模式界面
在现有的行为分析模式下，添加漏斗图选项：

```javascript
// 在AIChatInterface.vue中添加
const behaviorAnalysisOptions = [
  { 
    text: '🎯 行为转化漏斗', 
    type: 'select_analysis', 
    params: { 
      type: 'behavior_funnel', 
      description: '分析用户行为转化漏斗和关键节点' 
    } 
  },
  { 
    text: '⏱️ 时间漏斗分析', 
    type: 'select_analysis', 
    params: { 
      type: 'time_funnel', 
      description: '分析用户行为各步骤的时间分布' 
    } 
  },
  { 
    text: '📊 自定义流程漏斗', 
    type: 'select_analysis', 
    params: { 
      type: 'custom_funnel', 
      description: '自定义用户行为流程进行漏斗分析' 
    } 
  }
];
```

### 7.2 流程配置界面
```javascript
// 流程步骤配置组件
const FlowStepConfig = {
  template: `
    <div class="flow-step-config">
      <h3>配置流程步骤</h3>
      <div v-for="(step, index) in steps" :key="index" class="step-item">
        <a-input v-model="step.stepName" placeholder="步骤名称" />
        <a-input-number v-model="step.expectedDuration" placeholder="预期耗时(分钟)" />
        <a-button @click="removeStep(index)" type="danger">删除</a-button>
      </div>
      <a-button @click="addStep" type="primary">添加步骤</a-button>
    </div>
  `,
  data() {
    return {
      steps: [
        { stepName: '流程开始', expectedDuration: 15 },
        { stepName: '发起余额分账', expectedDuration: 15 },
        { stepName: '完成分账', expectedDuration: 5 }
      ]
    }
  }
};
```

## 8. 实现计划

### 8.1 第一阶段：核心功能实现
1. **创建数据处理器**
   - 实现 `BehaviorAnalysisDataProcessor`
   - 实现用户行为路径分析算法
   - 实现转化率计算算法

2. **扩展图表生成器**
   - 添加 `generateBehaviorFunnelOption` 方法
   - 实现时间信息展示
   - 实现自定义漏斗图配置

### 8.2 第二阶段：AI集成
1. **扩展需求解析器**
   - 添加行为分析提示词
   - 实现流程步骤识别
   - 集成AI分析功能

2. **智能分析功能**
   - 自动识别用户行为流程
   - 智能计算转化率
   - 自动生成漏斗图

### 8.3 第三阶段：用户界面优化
1. **界面集成**
   - 在行为分析模式下添加漏斗图选项
   - 实现流程配置界面
   - 添加时间范围选择

2. **用户体验优化**
   - 添加交互式配置
   - 实现实时预览
   - 添加导出功能

## 9. 技术难点与解决方案

### 9.1 用户行为路径识别
**难点**：如何从大量用户行为数据中识别出有意义的业务流程
**解决方案**：
- 使用AI进行智能识别
- 基于行为模式匹配
- 支持用户自定义流程定义

### 9.2 时间统计准确性
**难点**：如何准确计算每个步骤的耗时
**解决方案**：
- 基于用户会话进行时间计算
- 处理异常时间数据
- 提供多种时间统计方式

### 9.3 转化率计算
**难点**：如何准确计算各步骤间的转化率
**解决方案**：
- 基于用户唯一标识进行去重
- 支持多种转化率计算方式
- 处理数据异常情况

## 10. 测试策略

### 10.1 单元测试
- 数据处理器功能测试
- 转化率计算准确性测试
- 时间统计功能测试

### 10.2 集成测试
- AI分析功能测试
- 图表生成功能测试
- 用户界面交互测试

### 10.3 性能测试
- 大数据量处理性能测试
- 图表渲染性能测试
- 用户交互响应性能测试

## 11. 扩展性考虑

### 11.1 多维度分析
- 支持按用户群体分析
- 支持按时间段分析
- 支持按设备类型分析

### 11.2 高级功能
- 支持A/B测试对比
- 支持预测分析
- 支持异常检测

### 11.3 数据导出
- 支持多种格式导出
- 支持自定义报表
- 支持定时报告

---

**文档版本**：v1.0  
**创建日期**：2025-01-17  
**作者**：AI Assistant  
**状态**：设计阶段
