<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½™é¢åˆ†è´¦æµç¨‹æ•°æ®è½¬æ¢ - å®æ—¶æ¼”ç¤º</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .demo-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.85rem;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .json-viewer {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-success {
            background: #52c41a;
            color: white;
        }

        .btn-success:hover {
            background: #389e0d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .process-flow {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .flow-step {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .flow-step h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .flow-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .flow-detail {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
        }

        .flow-detail label {
            font-weight: 600;
            color: #2c3e50;
            display: block;
            margin-bottom: 3px;
            font-size: 0.8rem;
        }

        .flow-detail span {
            color: #666;
            font-size: 0.8rem;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success { background: #52c41a; }
        .status-warning { background: #faad14; }
        .status-error { background: #ff4d4f; }

        .full-width {
            grid-column: 1 / -1;
        }

        .chart-container {
            height: 400px;
            margin-top: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
        }

        .funnel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 20px;
        }

        .funnel-step {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 30px;
            margin: 5px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            position: relative;
            transition: all 0.3s ease;
            min-width: 300px;
        }

        .funnel-step:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .funnel-step:nth-child(1) { width: 100%; }
        .funnel-step:nth-child(2) { width: 85%; }
        .funnel-step:nth-child(3) { width: 70%; }
        .funnel-step:nth-child(4) { width: 55%; }
        .funnel-step:nth-child(5) { width: 40%; }

        .funnel-percentage {
            position: absolute;
            right: -80px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            min-width: 60px;
            text-align: center;
        }

        .funnel-count {
            position: absolute;
            left: -80px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            min-width: 60px;
            text-align: center;
        }

        .tab-btn {
            padding: 8px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            color: #ff6b35;
            border-bottom-color: #ff6b35;
        }

        .tab-btn:hover {
            color: #ff6b35;
        }

        .funnel-step-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .funnel-step-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .funnel-step-count {
            color: #666;
            font-size: 0.9rem;
        }

        .funnel-conversion-arrow {
            text-align: center;
            margin: 5px 0;
            color: #667eea;
            font-weight: 600;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* æ¼æ–—ç¼–è¾‘å™¨æ ·å¼ */
        .funnel-section {
            margin-bottom: 30px;
        }

        .funnel-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .required {
            color: #ff4d4f;
        }

        .help-icon {
            color: #999;
            cursor: help;
            margin-left: 5px;
        }

        .help-text {
            font-size: 0.9rem;
            color: #666;
            font-weight: normal;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .chart-type-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .chart-type-btn {
            padding: 12px 8px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            min-height: 60px;
        }

        .chart-type-btn .icon {
            font-size: 1.2rem;
        }

        .chart-type-btn.active {
            border-color: #ff6b35;
            background: #fff2ed;
            color: #ff6b35;
        }

        .chart-type-btn:hover {
            border-color: #ff6b35;
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-label input[type="radio"] {
            width: auto;
        }

        /* æ¼æ–—æ­¥éª¤æ ·å¼ */
        .funnel-steps-container {
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            background: #f8f9fa;
        }

        .funnel-step-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            cursor: move;
        }

        .funnel-step-item:last-child {
            margin-bottom: 0;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .step-number {
            width: 24px;
            height: 24px;
            background: #ff6b35;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .step-event {
            flex: 1;
        }

        .step-event select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .remove-step {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .remove-step:hover {
            color: #ff4d4f;
        }

        .filter-conditions {
            margin-top: 10px;
        }

        .filter-condition {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .filter-condition select {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .add-filter-btn {
            background: #f8f9fa;
            border: 1px dashed #ddd;
            color: #666;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .add-filter-btn:hover {
            background: #e9ecef;
        }

        .add-step-btn {
            width: 100%;
            background: #ff6b35;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
        }

        .add-step-btn:hover {
            background: #e55a2b;
        }

        @media (max-width: 1200px) {
            .demo-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .flow-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”„ ä½™é¢åˆ†è´¦æµç¨‹æ•°æ®è½¬æ¢</h1>
            <p>å®æ—¶æ¼”ç¤ºAPIæ•°æ®è½¬æ¢ä¸ºè®¾è®¡ç•Œé¢æ ¼å¼</p>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="demo-panel">
            <h2 class="panel-title">
                <span>ğŸ“Š</span>
                æ•°æ®ç»Ÿè®¡
            </h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalRecords">0</div>
                    <div class="stat-label">æ€»è®°å½•æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="convertedRecords">0</div>
                    <div class="stat-label">å·²è½¬æ¢</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="processNodes">0</div>
                    <div class="stat-label">æµç¨‹èŠ‚ç‚¹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uniqueUsers">0</div>
                    <div class="stat-label">ç”¨æˆ·æ•°</div>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="demo-panel">
            <h2 class="panel-title">
                <span>ğŸ›ï¸</span>
                æ§åˆ¶é¢æ¿
            </h2>
            <div class="controls">
                <button class="btn btn-primary" onclick="loadSampleData()">åŠ è½½ç¤ºä¾‹æ•°æ®</button>
                <button class="btn btn-primary" onclick="loadRealData()">è·å–çœŸå®æ•°æ®</button>
                <button class="btn btn-primary" onclick="loadBatchData()">æ‰¹é‡è·å–æ•°æ®</button>
                <button class="btn btn-secondary" onclick="validateToken()">éªŒè¯ä»¤ç‰Œ</button>
                <button class="btn btn-secondary" onclick="convertData()">è½¬æ¢æ•°æ®</button>
                <button class="btn btn-success" onclick="exportData()">å¯¼å‡ºç»“æœ</button>
                <button class="btn btn-secondary" onclick="generateDemoFunnel()">ç”Ÿæˆæ¼”ç¤ºæ¼æ–—</button>
                <button class="btn btn-secondary" onclick="openFunnelEditor()">ç¼–è¾‘æ¼æ–—</button>
                <button class="btn btn-secondary" onclick="clearData()">æ¸…ç©ºæ•°æ®</button>
            </div>
            
            <!-- APIé…ç½®åŒºåŸŸ -->
            <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                <h4 style="margin-bottom: 10px; color: #2c3e50;">APIé…ç½®</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">é¡¹ç›®ID:</label>
                        <input type="text" id="projectId" value="event1021" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">åŸ‹ç‚¹ID:</label>
                        <input type="text" id="selectedPointId" value="110" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">æŸ¥è¯¢æ—¥æœŸ:</label>
                        <input type="date" id="queryDate" value="2025-10-10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">é¡µé¢å¤§å°:</label>
                        <input type="number" id="pageSize" value="30" min="1" max="100" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">è®¿é—®ä»¤ç‰Œ:</label>
                    <input type="password" id="accessToken" placeholder="è¯·è¾“å…¥access-token" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
            </div>
        </div>

        <!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
        <div class="demo-grid">
            <!-- åŸå§‹APIæ•°æ® -->
            <div class="demo-panel">
                <h2 class="panel-title">
                    <span>ğŸ“¥</span>
                    åŸå§‹APIæ•°æ®
                </h2>
                <div class="json-viewer" id="originalData">
                    ç‚¹å‡»"åŠ è½½ç¤ºä¾‹æ•°æ®"å¼€å§‹æ¼”ç¤º...
                </div>
            </div>

            <!-- è½¬æ¢åæ•°æ® -->
            <div class="demo-panel">
                <h2 class="panel-title">
                    <span>ğŸ“¤</span>
                    è½¬æ¢åæ•°æ®
                </h2>
                <div class="json-viewer" id="convertedData">
                    ç‚¹å‡»"è½¬æ¢æ•°æ®"æŸ¥çœ‹ç»“æœ...
                </div>
            </div>
        </div>

        <!-- è¡¨æ ¼å±•ç¤º -->
        <div class="demo-panel full-width">
            <h2 class="panel-title">
                <span>ğŸ“‹</span>
                è½¬æ¢ç»“æœè¡¨æ ¼
            </h2>
            <div style="overflow-x: auto;">
                <table class="data-table" id="resultTable">
                    <thead>
                        <tr>
                            <th>æµç¨‹èŠ‚ç‚¹</th>
                            <th>é¡µé¢åç§°</th>
                            <th>ç±»å‹</th>
                            <th>è¡Œä¸º</th>
                            <th>è‡ªå®šä¹‰å†…å®¹</th>
                            <th>ç»“æœ</th>
                            <th>ç‰ˆæœ¬</th>
                            <th>è€—æ—¶</th>
                            <th>ç”¨æˆ·æ ‡è¯†</th>
                            <th>å•†æˆ·æ ‡è¯†</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="10" style="text-align: center; color: #999; padding: 20px;">
                                æš‚æ— æ•°æ®ï¼Œè¯·å…ˆåŠ è½½å’Œè½¬æ¢æ•°æ®
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æ¼æ–—å›¾åˆ†æ -->
        <div class="demo-panel full-width">
            <h2 class="panel-title">
                <span>ğŸ“Š</span>
                æ¼æ–—å›¾åˆ†æ
                <span style="font-size: 0.8rem; font-weight: normal; color: #666; margin-left: 10px;">
                    (<span id="funnelConfigName">åŸºäºæ¼æ–—é…ç½®ç”Ÿæˆ</span>)
                </span>
            </h2>
            
            <!-- æ¼æ–—æ¦‚è§ˆ -->
            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <!-- å·¦ä¾§æ¼æ–—æ¦‚è§ˆ -->
                <div style="flex: 1; background: #f8f9fa; border-radius: 8px; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #2c3e50; margin-bottom: 10px;">
                            æ€»è½¬åŒ–ç‡ <span id="totalConversionRate">0%</span>
                        </div>
                        <div style="width: 0; height: 0; border-left: 30px solid transparent; border-right: 30px solid transparent; border-top: 40px solid #667eea; margin: 0 auto;"></div>
                    </div>
                    
                    <div id="funnelOverview">
                        <div style="text-align: center; color: #999; padding: 20px;">
                            è½¬æ¢æ•°æ®åå°†æ˜¾ç¤ºæ¼æ–—æ¦‚è§ˆ
                        </div>
                    </div>
                </div>
                
                <!-- å³ä¾§å›¾è¡¨åŒºåŸŸ -->
                <div style="flex: 2;">
                    <!-- æ ‡ç­¾é¡µ -->
                    <div style="display: flex; border-bottom: 1px solid #e9ecef; margin-bottom: 15px;">
                        <button class="tab-btn active" onclick="switchFunnelTab('funnel')" id="funnelTab">æ¼æ–—</button>
                        <button class="tab-btn" onclick="switchFunnelTab('trend')" id="trendTab">è¶‹åŠ¿</button>
                        <button class="tab-btn" onclick="switchFunnelTab('table')" id="tableTab">è¡¨æ ¼</button>
                        <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                            <button style="background: none; border: none; cursor: pointer; padding: 5px;" onclick="refreshFunnelChart()">ğŸ”„</button>
                            <button style="background: none; border: none; cursor: pointer; padding: 5px;">â‹¯</button>
                        </div>
                    </div>
                    
                    <!-- å›¾è¡¨å®¹å™¨ -->
                    <div class="chart-container">
                        <div id="funnelChart" style="width: 100%; height: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æµç¨‹åˆ†æ -->
        <div class="demo-panel full-width">
            <h2 class="panel-title">
                <span>ğŸ”„</span>
                æµç¨‹åˆ†æ
            </h2>
            <div class="process-flow" id="processFlow">
                <div style="text-align: center; color: #999; padding: 20px;">
                    è½¬æ¢æ•°æ®åå°†æ˜¾ç¤ºæµç¨‹åˆ†æç»“æœ
                </div>
            </div>
        </div>
    </div>

    <!-- æ¼æ–—ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
    <div id="funnelEditorModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>ç¼–è¾‘æ¼æ–—</h2>
                <span class="close" onclick="closeFunnelEditor()">&times;</span>
            </div>
            
            <div class="modal-body">
                <!-- åŸºæœ¬è®¾ç½® -->
                <div class="funnel-section">
                    <h3>åŸºæœ¬è®¾ç½®</h3>
                    <div class="form-group">
                        <label>æ¼æ–—åç§° <span class="required">*</span></label>
                        <input type="text" id="funnelName" value="ä½™é¢åˆ†è´¦æµç¨‹" placeholder="è¯·è¾“å…¥æ¼æ–—åç§°">
                    </div>
                    
                    <div class="form-group">
                        <label>è½¬åŒ–å‘¨æœŸ <span class="required">*</span> <span class="help-icon">?</span></label>
                        <select id="conversionCycle">
                            <option value="1">ä¸€å¤©</option>
                            <option value="7">ä¸€å‘¨</option>
                            <option value="30">ä¸€æœˆ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>å›¾è¡¨é»˜è®¤ç±»å‹ <span class="required">*</span></label>
                        <div class="chart-type-buttons">
                            <button class="chart-type-btn active" data-type="funnel">
                                <span class="icon">ğŸ”½</span> æ¼æ–—å›¾
                            </button>
                            <button class="chart-type-btn" data-type="trend">
                                <span class="icon">ğŸ“ˆ</span> è¶‹åŠ¿
                            </button>
                            <button class="chart-type-btn" data-type="table">
                                <span class="icon">ğŸ“‹</span> è¡¨æ ¼
                            </button>
                            <button class="chart-type-btn" data-type="value_card">
                                <span class="icon">ğŸ”¢</span> æ•°å€¼å¡ç‰‡
                            </button>
                            <button class="chart-type-btn" data-type="bar_chart">
                                <span class="icon">ğŸ“Š</span> æŸ±çŠ¶å›¾
                            </button>
                            <button class="chart-type-btn" data-type="multi_line">
                                <span class="icon">ğŸ“‰</span> å¤šæŠ˜çº¿å›¾
                            </button>
                            <button class="chart-type-btn" data-type="bar_line">
                                <span class="icon">ğŸ“ŠğŸ“ˆ</span> æŸ±çº¿å›¾
                            </button>
                            <button class="chart-type-btn" data-type="stacked">
                                <span class="icon">ğŸ“š</span> å †å å›¾
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>è®¡æ•°ID <span class="required">*</span></label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="countId" value="builtin" checked>
                                <span class="radio-text">å†…ç½®ID</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="countId" value="user">
                                <span class="radio-text">ç”¨æˆ·ID</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- æ¼æ–—æ­¥éª¤ -->
                <div class="funnel-section">
                    <h3>æ¼æ–—æ­¥éª¤ <span class="help-text">(æ‹–åŠ¨å¯æ’åº)</span> <span class="required">*</span></h3>
                    <div id="funnelSteps" class="funnel-steps-container">
                        <!-- æ­¥éª¤å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <button class="add-step-btn" onclick="addFunnelStep()">
                        <span class="icon">+</span> å¢åŠ æ­¥éª¤
                    </button>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeFunnelEditor()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveFunnelConfig()">æ›´æ–°</button>
            </div>
        </div>
    </div>

    <script src="data_processor.js"></script>
    <script src="api_config.js"></script>
    <script>
        let currentData = [];
        let convertedData = [];
        let funnelChart = null;
        let currentFunnelTab = 'funnel';
        let yeepayAPI = new YeepayAPI();
        let funnelConfig = {
            name: 'ä½™é¢åˆ†è´¦æµç¨‹',
            conversionCycle: 1,
            defaultChartType: 'funnel',
            countId: 'builtin',
            steps: [
                {
                    id: 1,
                    event: 'page_view',
                    eventName: 'é¡µé¢æµè§ˆ',
                    filters: [
                        { field: 'page_name', operator: 'contains', value: '' }
                    ]
                },
                {
                    id: 2,
                    event: 'button_click',
                    eventName: 'æŒ‰é’®ç‚¹å‡»',
                    filters: [
                        { field: 'page_name', operator: 'contains', value: '' }
                    ]
                },
                {
                    id: 3,
                    event: 'button_click',
                    eventName: 'æŒ‰é’®ç‚¹å‡»',
                    filters: [
                        { field: 'page_name', operator: 'contains', value: '' }
                    ]
                },
                {
                    id: 4,
                    event: 'form_submit',
                    eventName: 'è¡¨å•æäº¤',
                    filters: [
                        { field: 'page_name', operator: 'contains', value: '' }
                    ]
                }
            ]
        };

        // ç¤ºä¾‹æ•°æ®
        const sampleData = [
            {
                "id": 7743,
                "pageName": "æ˜“åˆ†è´¦-åˆ†è´¦-åˆ†è´¦æŸ¥è¯¢",
                "type": "query",
                "content": "{\"å•†æˆ·ç¼–å·\":\"10086624159\",\"å˜æ›´ç”³è¯·çŠ¶æ€\":\"å…¨éƒ¨\"}",
                "weCustomerKey": "d56f0b85-32b9-452c-b445-5d07ba5970f7-20250729154128349",
                "weUserId": "10091502926",
                "wePath": "https://mp.yeepay.com/mp-galaxy/mp-separate-account/#/ledgerManage/ledger_query",
                "weDeviceName": "PC",
                "wePlatform": "Win32",
                "weSystem": "web ",
                "weOs": "web",
                "weBrowserName": "chrome",
                "weNewStatus": 2,
                "weIp": "10.201.77.173",
                "weCountry": "0",
                "weProvince": "0",
                "weCity": "å†…ç½‘IP",
                "createdAt": "2025-10-10T06:31:37.000Z"
            },
            {
                "id": 11350,
                "pageName": "æ˜“åˆ†è´¦-åˆ†è´¦-åˆ†è´¦å¤æ ¸",
                "type": "é¡µé¢",
                "stayTime": "30",
                "pageBehavior": "å…³é—­",
                "weCustomerKey": "5c571dc8-bc1c-4d7d-ab79-48d485f64850-20250910111015940",
                "weUserId": "10091461782",
                "wePath": "https://mp.yeepay.com/mp-galaxy/mp-separate-account/#/ledgerManage/ledger_review",
                "weDeviceName": "PC",
                "wePlatform": "Win32",
                "weSystem": "web ",
                "weOs": "web",
                "weBrowserName": "chrome",
                "weNewStatus": 2,
                "weIp": "10.203.12.129",
                "weCountry": "0",
                "weProvince": "0",
                "weCity": "å†…ç½‘IP",
                "createdAt": "2025-10-10T06:31:49.000Z"
            },
            {
                "id": 7744,
                "pageName": "å¯¹è´¦ç®¡ç†-å¯¹è´¦ä¸­å¿ƒ-äº¤æ˜“æŸ¥è¯¢",
                "type": "query",
                "content": "{\"pageNo\":1,\"pageSize\":20,\"timeType\":\"ORDER_START\",\"tradeTime\":[\"2025-09-01 00:00:00\",\"2025-09-30 23:59:59\"]}",
                "weCustomerKey": "ec12ffb5-73f7-4e25-b2ba-bc63e7988f57-20250930091635927",
                "weUserId": "10091627110",
                "wePath": "https://mp.yeepay.com/mp-galaxy/mp-merchant-access/#/tradeManage/queryMerchant",
                "weDeviceName": "PC",
                "wePlatform": "Win32",
                "weSystem": "web ",
                "weOs": "web",
                "weBrowserName": "edge",
                "weNewStatus": 2,
                "weIp": "10.201.77.173",
                "weCountry": "0",
                "weProvince": "0",
                "weCity": "å†…ç½‘IP",
                "createdAt": "2025-10-10T06:31:36.000Z"
            },
            {
                "id": 7731,
                "pageName": "å¤æ ¸é€šè¿‡",
                "type": "click",
                "content": "ç¡® è®¤",
                "weCustomerKey": "e0a274bd-ac71-4855-b894-33a539412d47-20250926165105548",
                "weUserId": "10091448783",
                "wePath": "https://mp.yeepay.com/mp-galaxy/mp-separate-account/#/ledgerManage/ledger_review",
                "weDeviceName": "PC",
                "wePlatform": "Win32",
                "weSystem": "web ",
                "weOs": "web",
                "weBrowserName": "edge",
                "weNewStatus": 2,
                "weIp": "10.203.13.129",
                "weCountry": "0",
                "weProvince": "0",
                "weCity": "å†…ç½‘IP",
                "createdAt": "2025-10-10T06:31:19.000Z"
            },
            {
                "id": 7725,
                "pageName": "è€æ¿ç®¡è´¦-å•†æˆ·å˜æ›´",
                "type": "query",
                "content": "{\"å˜æ›´ç±»å‹\":\"å…¨éƒ¨\",\"ç”³è¯·æ—¶é—´\":\"å…¶ä»–\",\"å®Œæˆæ—¶é—´\":\"å…¶ä»–\"}",
                "weCustomerKey": "d2118bfc-5a99-48c0-b187-6ad196c564fe-20250903165703653",
                "weUserId": "10091630318",
                "wePath": "https://mp.yeepay.com/mp-galaxy/mp-merchant-access/#/standardMerchantManage/querySubMerchantChange",
                "weDeviceName": "PC",
                "wePlatform": "Win32",
                "weSystem": "web ",
                "weOs": "web",
                "weBrowserName": "chrome",
                "weNewStatus": 2,
                "weIp": "10.201.77.173",
                "weCountry": "0",
                "weProvince": "0",
                "weCity": "å†…ç½‘IP",
                "createdAt": "2025-10-10T06:31:20.000Z"
            }
        ];

        // åŠ è½½ç¤ºä¾‹æ•°æ®
        function loadSampleData() {
            currentData = [...sampleData];
            document.getElementById('originalData').textContent = JSON.stringify(currentData, null, 2);
            updateStats();
        }

        // è·å–çœŸå®æ•°æ®
        async function loadRealData() {
            const projectId = document.getElementById('projectId').value;
            const selectedPointId = document.getElementById('selectedPointId').value;
            const queryDate = document.getElementById('queryDate').value;
            const pageSize = document.getElementById('pageSize').value;
            const accessToken = document.getElementById('accessToken').value;

            if (!accessToken) {
                alert('è¯·è¾“å…¥è®¿é—®ä»¤ç‰Œï¼');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('originalData').textContent = 'æ­£åœ¨è·å–æ•°æ®...';
            showMessage('æ­£åœ¨è·å–æ•°æ®ï¼Œè¯·ç¨å€™...', 'info');
            
            try {
                const config = {
                    projectId: projectId,
                    selectedPointId: selectedPointId,
                    pageSize: pageSize,
                    date: queryDate
                };

                const result = await yeepayAPI.searchBuryPointData(config, accessToken);
                
                if (result.data && result.data.dataList) {
                    currentData = result.data.dataList;
                    document.getElementById('originalData').textContent = JSON.stringify(result, null, 2);
                    updateStats();
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showMessage(`æ•°æ®è·å–æˆåŠŸï¼å…±è·å– ${currentData.length} æ¡è®°å½•`, 'success');
                } else {
                    throw new Error('è¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
                
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                document.getElementById('originalData').textContent = 'æ•°æ®è·å–å¤±è´¥: ' + error.message;
                showMessage('æ•°æ®è·å–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ‰¹é‡è·å–æ•°æ®
        async function loadBatchData() {
            const projectId = document.getElementById('projectId').value;
            const selectedPointId = document.getElementById('selectedPointId').value;
            const queryDate = document.getElementById('queryDate').value;
            const pageSize = document.getElementById('pageSize').value;
            const accessToken = document.getElementById('accessToken').value;

            if (!accessToken) {
                alert('è¯·è¾“å…¥è®¿é—®ä»¤ç‰Œï¼');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('originalData').textContent = 'æ­£åœ¨æ‰¹é‡è·å–æ•°æ®...';
            showMessage('æ­£åœ¨æ‰¹é‡è·å–æ•°æ®ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...', 'info');
            
            try {
                const config = {
                    projectId: projectId,
                    selectedPointId: selectedPointId,
                    pageSize: pageSize,
                    date: queryDate
                };

                const allData = await yeepayAPI.searchBuryPointDataBatch(config, accessToken, 5);
                
                if (allData.length > 0) {
                    currentData = allData;
                    document.getElementById('originalData').textContent = JSON.stringify({
                        code: 200,
                        msg: 'success',
                        data: {
                            total: allData.length,
                            dataList: allData
                        }
                    }, null, 2);
                    updateStats();
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showMessage(`æ‰¹é‡æ•°æ®è·å–æˆåŠŸï¼å…±è·å– ${allData.length} æ¡è®°å½•`, 'success');
                } else {
                    throw new Error('æ²¡æœ‰è·å–åˆ°ä»»ä½•æ•°æ®');
                }
                
            } catch (error) {
                console.error('æ‰¹é‡è·å–æ•°æ®å¤±è´¥:', error);
                document.getElementById('originalData').textContent = 'æ‰¹é‡æ•°æ®è·å–å¤±è´¥: ' + error.message;
                showMessage('æ‰¹é‡æ•°æ®è·å–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // éªŒè¯ä»¤ç‰Œ
        async function validateToken() {
            const accessToken = document.getElementById('accessToken').value;
            
            if (!accessToken) {
                alert('è¯·è¾“å…¥è®¿é—®ä»¤ç‰Œï¼');
                return;
            }

            showMessage('æ­£åœ¨éªŒè¯ä»¤ç‰Œ...', 'info');
            
            try {
                const isValid = await yeepayAPI.validateToken(accessToken);
                if (isValid) {
                    showMessage('ä»¤ç‰ŒéªŒè¯æˆåŠŸï¼', 'success');
                } else {
                    showMessage('ä»¤ç‰ŒéªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦æ­£ç¡®', 'error');
                }
            } catch (error) {
                showMessage('ä»¤ç‰ŒéªŒè¯å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                max-width: 300px;
                word-wrap: break-word;
                ${type === 'success' ? 'background: #52c41a;' : 
                  type === 'error' ? 'background: #ff4d4f;' : 
                  'background: #1890ff;'}
            `;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }

        // è½¬æ¢æ•°æ®
        function convertData() {
            if (currentData.length === 0) {
                alert('è¯·å…ˆåŠ è½½æ•°æ®ï¼');
                return;
            }

            convertedData = processor.convertBatch(currentData);
            document.getElementById('convertedData').textContent = JSON.stringify(convertedData, null, 2);
            updateTable();
            updateProcessFlow();
            updateFunnelChart();
            updateStats();
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('totalRecords').textContent = currentData.length;
            document.getElementById('convertedRecords').textContent = convertedData.length;
            
            const processNodes = new Set(convertedData.map(item => item["æµç¨‹èŠ‚ç‚¹"])).size;
            document.getElementById('processNodes').textContent = processNodes;
            
            const uniqueUsers = new Set(convertedData.map(item => item["ç”¨æˆ·æ ‡è¯†"])).size;
            document.getElementById('uniqueUsers').textContent = uniqueUsers;
        }

        // æ›´æ–°è¡¨æ ¼
        function updateTable() {
            const tableBody = document.getElementById('tableBody');
            
            if (convertedData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; color: #999; padding: 20px;">
                            æš‚æ— æ•°æ®
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = convertedData.map(record => `
                <tr>
                    <td>${record["æµç¨‹èŠ‚ç‚¹"]}</td>
                    <td>${record["é¡µé¢åç§°"]}</td>
                    <td>${record["ç±»å‹"]}</td>
                    <td>${record["è¡Œä¸º"]}</td>
                    <td title="${record["è‡ªå®šä¹‰å†…å®¹"]}">${record["è‡ªå®šä¹‰å†…å®¹"]}</td>
                    <td>
                        <span class="status-indicator ${record["ç»“æœ"] === 'æˆåŠŸ' ? 'status-success' : 'status-error'}"></span>
                        ${record["ç»“æœ"]}
                    </td>
                    <td>${record["ç‰ˆæœ¬"]}</td>
                    <td>${record["è€—æ—¶"]}s</td>
                    <td>${record["ç”¨æˆ·æ ‡è¯†"]}</td>
                    <td>${record["å•†æˆ·æ ‡è¯†"]}</td>
                </tr>
            `).join('');
        }

        // æ›´æ–°æµç¨‹åˆ†æ
        function updateProcessFlow() {
            const flowContainer = document.getElementById('processFlow');
            
            if (convertedData.length === 0) {
                flowContainer.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        æš‚æ— æ•°æ®
                    </div>
                `;
                return;
            }

            // æŒ‰æµç¨‹èŠ‚ç‚¹åˆ†ç»„
            const processGroups = {};
            convertedData.forEach(record => {
                const node = record["æµç¨‹èŠ‚ç‚¹"];
                if (!processGroups[node]) {
                    processGroups[node] = [];
                }
                processGroups[node].push(record);
            });

            // ç”Ÿæˆæµç¨‹æ­¥éª¤
            const flowSteps = Object.entries(processGroups).map(([node, records]) => {
                const totalTime = records.reduce((sum, record) => sum + (parseInt(record["è€—æ—¶"]) || 0), 0);
                const avgTime = Math.round(totalTime / records.length);
                const successRate = (records.filter(r => r["ç»“æœ"] === "æˆåŠŸ").length / records.length * 100).toFixed(1);

                return `
                    <div class="flow-step">
                        <h4>${node}</h4>
                        <div class="flow-details">
                            <div class="flow-detail">
                                <label>æ“ä½œæ¬¡æ•°:</label>
                                <span>${records.length}</span>
                            </div>
                            <div class="flow-detail">
                                <label>å¹³å‡è€—æ—¶:</label>
                                <span>${avgTime}ç§’</span>
                            </div>
                            <div class="flow-detail">
                                <label>æˆåŠŸç‡:</label>
                                <span>${successRate}%</span>
                            </div>
                            <div class="flow-detail">
                                <label>æ¶‰åŠç”¨æˆ·:</label>
                                <span>${new Set(records.map(r => r["ç”¨æˆ·æ ‡è¯†"])).size}äºº</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            flowContainer.innerHTML = flowSteps;
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            if (convertedData.length === 0) {
                alert('è¯·å…ˆè½¬æ¢æ•°æ®ï¼');
                return;
            }

            const csv = processor.exportToCSV(convertedData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'ä½™é¢åˆ†è´¦æµç¨‹æ•°æ®.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æ›´æ–°æ¼æ–—å›¾
        function updateFunnelChart() {
            if (convertedData.length === 0) {
                document.getElementById('funnelSteps').innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        æš‚æ— æ•°æ®
                    </div>
                `;
                return;
            }

            // æŒ‰æµç¨‹èŠ‚ç‚¹ç»Ÿè®¡
            const processStats = {};
            convertedData.forEach(record => {
                const node = record["æµç¨‹èŠ‚ç‚¹"];
                if (!processStats[node]) {
                    processStats[node] = {
                        count: 0,
                        successCount: 0,
                        totalTime: 0
                    };
                }
                processStats[node].count++;
                if (record["ç»“æœ"] === "æˆåŠŸ") {
                    processStats[node].successCount++;
                }
                processStats[node].totalTime += parseInt(record["è€—æ—¶"]) || 0;
            });

            // ä½¿ç”¨æ¼æ–—é…ç½®ä¸­å®šä¹‰çš„æ­¥éª¤é¡ºåº
            const configuredSteps = funnelConfig.steps.map(step => step.eventName);
            
            // æ ¹æ®é…ç½®çš„æ­¥éª¤é¡ºåºç”Ÿæˆæ¼æ–—æ•°æ®
            const funnelData = [];
            const funnelSteps = [];
            let maxCount = 0;

            configuredSteps.forEach(stepName => {
                const stats = processStats[stepName] || { count: 0, successCount: 0, totalTime: 0 };
                maxCount = Math.max(maxCount, stats.count);
                
                funnelData.push({
                    name: stepName,
                    value: stats.count
                });
                
                funnelSteps.push({
                    name: stepName,
                    count: stats.count,
                    successRate: stats.count > 0 ? ((stats.successCount / stats.count) * 100).toFixed(1) : '0.0',
                    avgTime: stats.count > 0 ? Math.round(stats.totalTime / stats.count) : 0
                });
            });

            // æ›´æ–°EChartsæ¼æ–—å›¾
            updateEChartsFunnel(funnelData);

            // æ›´æ–°æ¼æ–—æ¦‚è§ˆ
            updateFunnelOverview(funnelData);

            // æ›´æ–°HTMLæ¼æ–—æ­¥éª¤
            updateHTMLFunnel(funnelSteps, maxCount);
        }

        // æ›´æ–°EChartsæ¼æ–—å›¾
        function updateEChartsFunnel(data) {
            const chartDom = document.getElementById('funnelChart');
            if (!chartDom) {
                console.error('æ¼æ–—å›¾å®¹å™¨æœªæ‰¾åˆ°');
                return;
            }

            if (!funnelChart) {
                funnelChart = echarts.init(chartDom);
            }

            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            if (!data || data.length === 0) {
                const emptyOption = {
                    title: {
                        text: 'æš‚æ— æ¼æ–—å›¾æ•°æ®',
                        left: 'center',
                        top: 'center',
                        textStyle: {
                            color: '#999',
                            fontSize: 16
                        }
                    }
                };
                funnelChart.setOption(emptyOption);
                return;
            }

            const option = {
                title: {
                    text: 'ä½™é¢åˆ†è´¦æµç¨‹æ¼æ–—å›¾',
                    left: 'center',
                    top: 20,
                    textStyle: {
                        color: '#2c3e50',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const unit = funnelConfig.countId === 'user' ? 'äºº' : 'æ¬¡';
                        return `${params.name}<br/>æ“ä½œ${unit === 'äºº' ? 'äººæ•°' : 'æ¬¡æ•°'}: ${params.value}${unit}<br/>å æ¯”: ${params.percent}%`;
                    }
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    top: 'middle',
                    data: data.map(item => item.name)
                },
                series: [
                    {
                        name: 'æµç¨‹æ­¥éª¤',
                        type: 'funnel',
                        left: '20%',
                        top: 60,
                        bottom: 60,
                        width: '60%',
                        min: 0,
                        max: Math.max(...data.map(item => item.value)),
                        minSize: '0%',
                        maxSize: '100%',
                        sort: 'descending',
                        gap: 2,
                        label: {
                            show: true,
                            position: 'inside',
                            formatter: function(params) {
                                const unit = funnelConfig.countId === 'user' ? 'äºº' : 'æ¬¡';
                                return `${params.name}\n${params.value}${unit}`;
                            },
                            fontSize: 11,
                            color: '#fff',
                            fontWeight: 'bold'
                        },
                        labelLine: {
                            length: 10,
                            lineStyle: {
                                width: 1,
                                type: 'solid'
                            }
                        },
                        itemStyle: {
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        emphasis: {
                            label: {
                                fontSize: 13
                            },
                            itemStyle: {
                                shadowBlur: 10,
                                shadowColor: 'rgba(0, 0, 0, 0.3)'
                            }
                        },
                        data: data.map((item, index) => ({
                            ...item,
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: `hsl(${240 + index * 30}, 70%, 60%)` },
                                    { offset: 1, color: `hsl(${240 + index * 30}, 70%, 40%)` }
                                ])
                            }
                        }))
                    }
                ]
            };

            funnelChart.setOption(option, true);
            
            // ç¡®ä¿å›¾è¡¨æ­£ç¡®æ¸²æŸ“
            setTimeout(() => {
                funnelChart.resize();
            }, 100);
        }

        // æ›´æ–°HTMLæ¼æ–—æ­¥éª¤
        function updateHTMLFunnel(steps, maxCount) {
            const container = document.getElementById('funnelSteps');
            
            if (steps.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        æš‚æ— æ•°æ®
                    </div>
                `;
                return;
            }

            const funnelHTML = steps.map((step, index) => {
                const percentage = ((step.count / maxCount) * 100).toFixed(1);
                const width = Math.max(40, percentage);
                const unit = funnelConfig.countId === 'user' ? 'äºº' : 'æ¬¡';
                
                return `
                    <div class="funnel-step" style="width: ${width}%;">
                        <div class="funnel-count">${step.count}${unit}</div>
                        ${step.name}
                        <div class="funnel-percentage">${percentage}%</div>
                        <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.9;">
                            æˆåŠŸç‡: ${step.successRate}% | å¹³å‡è€—æ—¶: ${step.avgTime}s
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = funnelHTML;
        }

        // åˆ‡æ¢æ¼æ–—æ ‡ç­¾é¡µ
        function switchFunnelTab(tabName) {
            currentFunnelTab = tabName;
            
            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // æ ¹æ®æ ‡ç­¾é¡µæ›´æ–°å›¾è¡¨
            updateFunnelChartByTab();
        }

        // æ ¹æ®æ ‡ç­¾é¡µæ›´æ–°å›¾è¡¨
        function updateFunnelChartByTab() {
            if (convertedData.length === 0) {
                updateEChartsFunnel([]);
                return;
            }

            switch(currentFunnelTab) {
                case 'funnel':
                    updateFunnelChart();
                    break;
                case 'trend':
                    updateTrendChart();
                    break;
                case 'table':
                    updateTableChart();
                    break;
                case 'value_card':
                    updateValueCardChart();
                    break;
                case 'bar_chart':
                    updateBarChart();
                    break;
                case 'multi_line':
                    updateMultiLineChart();
                    break;
                case 'bar_line':
                    updateBarLineChart();
                    break;
                case 'stacked':
                    updateStackedChart();
                    break;
            }
        }

        // æ›´æ–°è¶‹åŠ¿å›¾
        function updateTrendChart() {
            const chartDom = document.getElementById('funnelChart');
            if (!chartDom) return;

            if (!funnelChart) {
                funnelChart = echarts.init(chartDom);
            }

            // ç”Ÿæˆæ¨¡æ‹Ÿè¶‹åŠ¿æ•°æ®
            const dates = [];
            const values = [];
            const today = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push((date.getMonth() + 1).toString().padStart(2, '0') + '-' + date.getDate().toString().padStart(2, '0'));
                values.push(Math.random() * 100);
            }

            const option = {
                title: {
                    text: 'æ€»è½¬åŒ–ç‡è¶‹åŠ¿',
                    left: 'center',
                    top: 20,
                    textStyle: {
                        color: '#2c3e50',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        return `${params[0].axisValue}<br/>è½¬åŒ–ç‡: ${params[0].value.toFixed(2)}%`;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: {
                        interval: 4
                    }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    axisLabel: {
                        formatter: '{value}%'
                    }
                },
                series: [{
                    name: 'è½¬åŒ–ç‡',
                    type: 'line',
                    data: values,
                    smooth: true,
                    lineStyle: {
                        color: '#667eea',
                        width: 2
                    },
                    itemStyle: {
                        color: '#667eea'
                    },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(102, 126, 234, 0.3)' },
                            { offset: 1, color: 'rgba(102, 126, 234, 0.1)' }
                        ])
                    }
                }]
            };

            funnelChart.setOption(option, true);
        }

        // æ›´æ–°è¡¨æ ¼å›¾è¡¨
        function updateTableChart() {
            const chartDom = document.getElementById('funnelChart');
            if (!chartDom) return;

            if (!funnelChart) {
                funnelChart = echarts.init(chartDom);
            }

            // ç”Ÿæˆè¡¨æ ¼æ•°æ®
            const processStats = {};
            convertedData.forEach(record => {
                const node = record["æµç¨‹èŠ‚ç‚¹"];
                if (!processStats[node]) {
                    processStats[node] = {
                        count: 0,
                        successCount: 0,
                        totalTime: 0
                    };
                }
                processStats[node].count++;
                if (record["ç»“æœ"] === "æˆåŠŸ") {
                    processStats[node].successCount++;
                }
                processStats[node].totalTime += parseInt(record["è€—æ—¶"]) || 0;
            });

            const tableData = Object.entries(processStats).map(([name, stats]) => [
                name,
                stats.count,
                ((stats.successCount / stats.count) * 100).toFixed(1) + '%',
                Math.round(stats.totalTime / stats.count) + 's'
            ]);

            const option = {
                title: {
                    text: 'æµç¨‹æ•°æ®è¡¨æ ¼',
                    left: 'center',
                    top: 20,
                    textStyle: {
                        color: '#2c3e50',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'item'
                },
                series: [{
                    type: 'table',
                    left: 'center',
                    top: 60,
                    width: '90%',
                    height: '70%',
                    data: [
                        ['æµç¨‹èŠ‚ç‚¹', funnelConfig.countId === 'user' ? 'æ“ä½œäººæ•°' : 'æ“ä½œæ¬¡æ•°', 'æˆåŠŸç‡', 'å¹³å‡è€—æ—¶'],
                        ...tableData
                    ],
                    headerHeight: 40,
                    itemHeight: 30,
                    textStyle: {
                        fontSize: 12
                    }
                }]
            };

            funnelChart.setOption(option, true);
        }

        // æ›´æ–°æ•°å€¼å¡ç‰‡
        function updateValueCardChart() {
            const chartDom = document.getElementById('funnelChart');
            if (!chartDom) return;

            if (!funnelChart) {
                funnelChart = echarts.init(chartDom);
            }

            // è®¡ç®—æ€»è½¬åŒ–ç‡
            const processStats = {};
            convertedData.forEach(record => {
                const node = record["æµç¨‹èŠ‚ç‚¹"];
                if (!processStats[node]) {
                    processStats[node] = { count: 0, successCount: 0 };
                }
                processStats[node].count++;
                if (record["ç»“æœ"] === "æˆåŠŸ") {
                    processStats[node].successCount++;
                }
            });

            const steps = Object.values(processStats);
            const totalConversion = steps.length > 1 ? 
                ((steps[steps.length - 1].count / steps[0].count) * 100).toFixed(1) : 100;

            const option = {
                title: {
                    text: 'æ€»è½¬åŒ–ç‡',
                    left: 'center',
                    top: 'center',
                    textStyle: {
                        fontSize: 48,
                        fontWeight: 'bold',
                        color: '#ff6b35'
                    }
                },
                series: [{
                    type: 'gauge',
                    center: ['50%', '60%'],
                    radius: '80%',
                    min: 0,
                    max: 100,
                    splitNumber: 10,
                    axisLine: {
                        lineStyle: {
                            width: 6,
                            color: [
                                [0.3, '#ff6b35'],
                                [0.7, '#37a2da'],
                                [1, '#67e0e3']
                            ]
                        }
                    },
                    pointer: {
                        itemStyle: {
                            color: 'auto'
                        }
                    },
                    axisTick: {
                        distance: -30,
                        splitNumber: 5,
                        lineStyle: {
                            width: 2,
                            color: '#999'
                        }
                    },
                    splitLine: {
                        distance: -30,
                        length: 30,
                        lineStyle: {
                            width: 4,
                            color: '#999'
                        }
                    },
                    axisLabel: {
                        color: 'auto',
                        distance: 40,
                        fontSize: 20
                    },
                    detail: {
                        valueAnimation: true,
                        formatter: '{value}%',
                        color: 'auto',
                        fontSize: 30,
                        fontWeight: 'bold'
                    },
                    data: [{
                        value: totalConversion
                    }]
                }]
            };

            funnelChart.setOption(option, true);
        }

        // æ›´æ–°æŸ±çŠ¶å›¾
        function updateBarChart() {
            const chartDom = document.getElementById('funnelChart');
            if (!chartDom) return;

            if (!funnelChart) {
                funnelChart = echarts.init(chartDom);
            }

            const processStats = {};
            convertedData.forEach(record => {
                const node = record["æµç¨‹èŠ‚ç‚¹"];
                if (!processStats[node]) {
                    processStats[node] = { count: 0, successCount: 0 };
                }
                processStats[node].count++;
                if (record["ç»“æœ"] === "æˆåŠŸ") {
                    processStats[node].successCount++;
                }
            });

            const configuredSteps = funnelConfig.steps.map(step => step.eventName);
            const data = configuredSteps.map(stepName => {
                const stats = processStats[stepName] || { count: 0, successCount: 0 };
                return {
                    name: stepName,
                    value: stats.count,
                    successRate: stats.count > 0 ? ((stats.successCount / stats.count) * 100).toFixed(1) : 0
                };
            });

            const option = {
                title: {
                    text: 'æµç¨‹æ­¥éª¤æŸ±çŠ¶å›¾',
                    left: 'center',
                    top: 20,
                    textStyle: {
                        color: '#2c3e50',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const unit = funnelConfig.countId === 'user' ? 'äºº' : 'æ¬¡';
                        return `${params[0].name}<br/>æ“ä½œ${unit === 'äºº' ? 'äººæ•°' : 'æ¬¡æ•°'}: ${params[0].value}${unit}<br/>æˆåŠŸç‡: ${params[0].data.successRate}%`;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: data.map(item => item.name),
                    axisLabel: {
                        rotate: 45,
                        fontSize: 10
                    }
                },
                yAxis: {
                    type: 'value',
                    name: funnelConfig.countId === 'user' ? 'äººæ•°' : 'æ¬¡æ•°'
                },
                series: [{
                    name: 'æ“ä½œæ¬¡æ•°',
                    type: 'bar',
                    data: data,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#667eea' },
                            { offset: 1, color: '#764ba2' }
                        ])
                    },
                    emphasis: {
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#ff6b35' },
                                { offset: 1, color: '#e55a2b' }
                            ])
                        }
                    }
                }]
            };

            funnelChart.setOption(option, true);
        }

        // æ›´æ–°å¤šæŠ˜çº¿å›¾
        function updateMultiLineChart() {
            const chartDom = document.getElementById('funnelChart');
            if (!chartDom) return;

            if (!funnelChart) {
                funnelChart = echarts.init(chartDom);
            }

            // ç”Ÿæˆæ¨¡æ‹Ÿçš„æ—¶é—´åºåˆ—æ•°æ®
            const dates = [];
            const today = new Date();
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push((date.getMonth() + 1).toString().padStart(2, '0') + '-' + date.getDate().toString().padStart(2, '0'));
            }

            const configuredSteps = funnelConfig.steps.map(step => step.eventName);
            const series = configuredSteps.map((stepName, index) => {
                const baseValue = 1000 - index * 100;
                const data = dates.map(() => Math.max(0, baseValue + Math.random() * 200 - 100));
                return {
                    name: stepName,
                    type: 'line',
                    data: data,
                    smooth: true,
                    lineStyle: {
                        width: 2
                    },
                    itemStyle: {
                        color: `hsl(${240 + index * 60}, 70%, 60%)`
                    }
                };
            });

            const option = {
                title: {
                    text: 'æµç¨‹æ­¥éª¤è¶‹åŠ¿å›¾',
                    left: 'center',
                    top: 20,
                    textStyle: {
                        color: '#2c3e50',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const unit = funnelConfig.countId === 'user' ? 'äºº' : 'æ¬¡';
                        let result = `${params[0].axisValue}<br/>`;
                        params.forEach(param => {
                            result += `${param.seriesName}: ${param.value}${unit}<br/>`;
                        });
                        return result;
                    }
                },
                legend: {
                    data: configuredSteps,
                    top: 50
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: {
                        interval: 4
                    }
                },
                yAxis: {
                    type: 'value',
                    name: funnelConfig.countId === 'user' ? 'äººæ•°' : 'æ¬¡æ•°'
                },
                series: series
            };

            funnelChart.setOption(option, true);
        }

        // æ›´æ–°æŸ±çº¿å›¾
        function updateBarLineChart() {
            const chartDom = document.getElementById('funnelChart');
            if (!chartDom) return;

            if (!funnelChart) {
                funnelChart = echarts.init(chartDom);
            }

            const processStats = {};
            convertedData.forEach(record => {
                const node = record["æµç¨‹èŠ‚ç‚¹"];
                if (!processStats[node]) {
                    processStats[node] = { count: 0, successCount: 0 };
                }
                processStats[node].count++;
                if (record["ç»“æœ"] === "æˆåŠŸ") {
                    processStats[node].successCount++;
                }
            });

            const configuredSteps = funnelConfig.steps.map(step => step.eventName);
            const data = configuredSteps.map(stepName => {
                const stats = processStats[stepName] || { count: 0, successCount: 0 };
                return {
                    name: stepName,
                    value: stats.count,
                    successRate: stats.count > 0 ? ((stats.successCount / stats.count) * 100) : 0
                };
            });

            const option = {
                title: {
                    text: 'æµç¨‹æ­¥éª¤æŸ±çº¿å›¾',
                    left: 'center',
                    top: 20,
                    textStyle: {
                        color: '#2c3e50',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                legend: {
                    data: ['æ“ä½œæ¬¡æ•°', 'æˆåŠŸç‡'],
                    top: 50
                },
                xAxis: {
                    type: 'category',
                    data: data.map(item => item.name),
                    axisLabel: {
                        rotate: 45,
                        fontSize: 10
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: funnelConfig.countId === 'user' ? 'äººæ•°' : 'æ¬¡æ•°',
                        position: 'left'
                    },
                    {
                        type: 'value',
                        name: 'æˆåŠŸç‡(%)',
                        position: 'right',
                        max: 100
                    }
                ],
                series: [
                    {
                        name: 'æ“ä½œæ¬¡æ•°',
                        type: 'bar',
                        data: data.map(item => item.value),
                        itemStyle: {
                            color: '#667eea'
                        }
                    },
                    {
                        name: 'æˆåŠŸç‡',
                        type: 'line',
                        yAxisIndex: 1,
                        data: data.map(item => item.successRate),
                        lineStyle: {
                            color: '#ff6b35'
                        },
                        itemStyle: {
                            color: '#ff6b35'
                        }
                    }
                ]
            };

            funnelChart.setOption(option, true);
        }

        // æ›´æ–°å †å å›¾
        function updateStackedChart() {
            const chartDom = document.getElementById('funnelChart');
            if (!chartDom) return;

            if (!funnelChart) {
                funnelChart = echarts.init(chartDom);
            }

            const processStats = {};
            convertedData.forEach(record => {
                const node = record["æµç¨‹èŠ‚ç‚¹"];
                if (!processStats[node]) {
                    processStats[node] = { count: 0, successCount: 0 };
                }
                processStats[node].count++;
                if (record["ç»“æœ"] === "æˆåŠŸ") {
                    processStats[node].successCount++;
                }
            });

            const configuredSteps = funnelConfig.steps.map(step => step.eventName);
            const data = configuredSteps.map(stepName => {
                const stats = processStats[stepName] || { count: 0, successCount: 0 };
                return {
                    name: stepName,
                    success: stats.successCount,
                    failed: stats.count - stats.successCount
                };
            });

            const option = {
                title: {
                    text: 'æµç¨‹æ­¥éª¤å †å å›¾',
                    left: 'center',
                    top: 20,
                    textStyle: {
                        color: '#2c3e50',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['æˆåŠŸ', 'å¤±è´¥'],
                    top: 50
                },
                xAxis: {
                    type: 'category',
                    data: data.map(item => item.name),
                    axisLabel: {
                        rotate: 45,
                        fontSize: 10
                    }
                },
                yAxis: {
                    type: 'value',
                    name: funnelConfig.countId === 'user' ? 'äººæ•°' : 'æ¬¡æ•°'
                },
                series: [
                    {
                        name: 'æˆåŠŸ',
                        type: 'bar',
                        stack: 'total',
                        data: data.map(item => item.success),
                        itemStyle: {
                            color: '#52c41a'
                        }
                    },
                    {
                        name: 'å¤±è´¥',
                        type: 'bar',
                        stack: 'total',
                        data: data.map(item => item.failed),
                        itemStyle: {
                            color: '#ff4d4f'
                        }
                    }
                ]
            };

            funnelChart.setOption(option, true);
        }

        // åˆ·æ–°æ¼æ–—å›¾
        function refreshFunnelChart() {
            if (convertedData.length > 0) {
                updateFunnelChartByTab();
            } else {
                alert('è¯·å…ˆåŠ è½½å’Œè½¬æ¢æ•°æ®ï¼');
            }
        }

        // ç”Ÿæˆæ¼”ç¤ºæ¼æ–—å›¾
        function generateDemoFunnel() {
            // ç”ŸæˆåŸºäºçœŸå®ä¸šåŠ¡åœºæ™¯çš„æ¼”ç¤ºæ•°æ®
            const demoSteps = [
                { name: 'ä½™é¢åˆ†è´¦æŸ¥è¯¢', value: 1000, successRate: 98.5, avgTime: 2 },
                { name: 'åˆ†è´¦æ“ä½œ', value: 850, successRate: 95.2, avgTime: 8 },
                { name: 'åˆ†è´¦å¤æ ¸', value: 720, successRate: 92.8, avgTime: 15 },
                { name: 'å®‰å…¨éªŒè¯', value: 650, successRate: 89.5, avgTime: 5 },
                { name: 'ç³»ç»Ÿæç¤º', value: 580, successRate: 96.8, avgTime: 3 }
            ];
            
            // æ›´æ–°EChartsæ¼æ–—å›¾
            updateEChartsFunnel(demoSteps);
            
            // æ›´æ–°æ¼æ–—æ¦‚è§ˆ
            updateFunnelOverview(demoSteps);
            
            // æ›´æ–°HTMLæ¼æ–—æ­¥éª¤
            const demoStepsForHTML = demoSteps.map(item => ({
                name: item.name,
                count: item.value,
                successRate: item.successRate.toFixed(1),
                avgTime: item.avgTime
            }));
            
            updateHTMLFunnel(demoStepsForHTML, 1000);
            
            showMessage('æ¼”ç¤ºæ¼æ–—å›¾å·²ç”Ÿæˆ', 'success');
        }

        // æ›´æ–°æ¼æ–—æ¦‚è§ˆ
        function updateFunnelOverview(data) {
            if (!data || data.length === 0) {
                document.getElementById('funnelOverview').innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        æš‚æ— æ•°æ®
                    </div>
                `;
                document.getElementById('totalConversionRate').textContent = '0%';
                return;
            }

            const totalConversion = data.length > 1 ? 
                ((data[data.length - 1].value / data[0].value) * 100).toFixed(1) : 100;
            
            document.getElementById('totalConversionRate').textContent = totalConversion + '%';

            let overviewHTML = '';
            for (let i = 0; i < data.length; i++) {
                const item = data[i];
                const stepNumber = i + 1;
                
                // ä½¿ç”¨æ¼æ–—é…ç½®ä¸­çš„æ­¥éª¤åç§°
                const stepConfig = funnelConfig.steps[i];
                const stepDisplayName = stepConfig ? stepConfig.eventName : item.name;
                
                // æ ¹æ®è®¡æ•°IDç±»å‹ç¡®å®šå•ä½
                const unit = funnelConfig.countId === 'user' ? 'äºº' : 'æ¬¡';
                
                overviewHTML += `
                    <div class="funnel-step-item">
                        <div class="funnel-step-name">ç¬¬${stepNumber}æ­¥ ${stepDisplayName}</div>
                        <div class="funnel-step-count">${item.value}${unit}</div>
                    </div>
                `;
                
                if (i < data.length - 1) {
                    const nextItem = data[i + 1];
                    const conversionRate = item.value > 0 ? ((nextItem.value / item.value) * 100).toFixed(1) : '0.0';
                    overviewHTML += `
                        <div class="funnel-conversion-arrow">
                            <div style="width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 20px solid #667eea; margin: 0 auto;"></div>
                            <div style="margin-top: 5px;">${conversionRate}%</div>
                        </div>
                    `;
                }
            }

            document.getElementById('funnelOverview').innerHTML = overviewHTML;
        }

        // æ¸…ç©ºæ•°æ®
        function clearData() {
            currentData = [];
            convertedData = [];
            document.getElementById('originalData').textContent = 'ç‚¹å‡»"åŠ è½½ç¤ºä¾‹æ•°æ®"å¼€å§‹æ¼”ç¤º...';
            document.getElementById('convertedData').textContent = 'ç‚¹å‡»"è½¬æ¢æ•°æ®"æŸ¥çœ‹ç»“æœ...';
            updateTable();
            updateProcessFlow();
            updateFunnelChart();
            updateStats();
        }

        // æ¼æ–—ç¼–è¾‘å™¨åŠŸèƒ½
        function openFunnelEditor() {
            document.getElementById('funnelEditorModal').style.display = 'flex';
            loadFunnelConfig();
            renderFunnelSteps();
        }

        function closeFunnelEditor() {
            document.getElementById('funnelEditorModal').style.display = 'none';
        }

        function loadFunnelConfig() {
            document.getElementById('funnelName').value = funnelConfig.name;
            document.getElementById('conversionCycle').value = funnelConfig.conversionCycle;
            
            // è®¾ç½®å›¾è¡¨ç±»å‹æŒ‰é’®
            document.querySelectorAll('.chart-type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === funnelConfig.defaultChartType) {
                    btn.classList.add('active');
                }
            });
            
            // è®¾ç½®è®¡æ•°ID
            document.querySelector(`input[name="countId"][value="${funnelConfig.countId}"]`).checked = true;
        }

        function renderFunnelSteps() {
            const container = document.getElementById('funnelSteps');
            container.innerHTML = '';
            
            funnelConfig.steps.forEach((step, index) => {
                const stepElement = createStepElement(step, index + 1);
                container.appendChild(stepElement);
            });
        }

        function createStepElement(step, stepNumber) {
            const div = document.createElement('div');
            div.className = 'funnel-step-item';
            div.dataset.stepId = step.id;
            
            div.innerHTML = `
                <div class="step-header">
                    <div class="step-number">${stepNumber}</div>
                    <div class="step-event">
                        <select onchange="updateStepEvent(${step.id}, this.value)">
                            <option value="page_click" ${step.event === 'page_click' ? 'selected' : ''}>é¡µé¢ç‚¹å‡»ã€é€šç”¨æ–°ã€‘</option>
                            <option value="page_view" ${step.event === 'page_view' ? 'selected' : ''}>é¡µé¢æµè§ˆ</option>
                            <option value="button_click" ${step.event === 'button_click' ? 'selected' : ''}>æŒ‰é’®ç‚¹å‡»</option>
                            <option value="form_submit" ${step.event === 'form_submit' ? 'selected' : ''}>è¡¨å•æäº¤</option>
                            <option value="custom_event" ${step.event === 'custom_event' ? 'selected' : ''}>è‡ªå®šä¹‰äº‹ä»¶</option>
                        </select>
                    </div>
                    <button class="remove-step" onclick="removeFunnelStep(${step.id})">âˆ’</button>
                </div>
                <div class="filter-conditions">
                    ${step.filters.map((filter, index) => `
                        <div class="filter-condition">
                            <select onchange="updateFilterField(${step.id}, ${index}, 'field', this.value)">
                                <option value="builtin_id" ${filter.field === 'builtin_id' ? 'selected' : ''}>å†…ç½®ID</option>
                                <option value="user_id" ${filter.field === 'user_id' ? 'selected' : ''}>ç”¨æˆ·ID</option>
                                <option value="page_name" ${filter.field === 'page_name' ? 'selected' : ''}>é¡µé¢åç§°</option>
                                <option value="event_type" ${filter.field === 'event_type' ? 'selected' : ''}>äº‹ä»¶ç±»å‹</option>
                            </select>
                            <select onchange="updateFilterField(${step.id}, ${index}, 'operator', this.value)">
                                <option value="empty" ${filter.operator === 'empty' ? 'selected' : ''}>ä¸ºç©º</option>
                                <option value="not_empty" ${filter.operator === 'not_empty' ? 'selected' : ''}>ä¸ä¸ºç©º</option>
                                <option value="equals" ${filter.operator === 'equals' ? 'selected' : ''}>ç­‰äº</option>
                                <option value="not_equals" ${filter.operator === 'not_equals' ? 'selected' : ''}>ä¸ç­‰äº</option>
                                <option value="contains" ${filter.operator === 'contains' ? 'selected' : ''}>åŒ…å«</option>
                            </select>
                            <button class="remove-step" onclick="removeFilter(${step.id}, ${index})">âˆ’</button>
                        </div>
                    `).join('')}
                    <button class="add-filter-btn" onclick="addFilter(${step.id})">+ ç­›é€‰æ¡ä»¶</button>
                </div>
            `;
            
            return div;
        }

        function addFunnelStep() {
            const newId = Math.max(...funnelConfig.steps.map(s => s.id)) + 1;
            const newStep = {
                id: newId,
                event: 'page_click',
                eventName: 'é¡µé¢ç‚¹å‡»ã€é€šç”¨æ–°ã€‘',
                filters: [
                    { field: 'builtin_id', operator: 'empty', value: '' }
                ]
            };
            
            funnelConfig.steps.push(newStep);
            renderFunnelSteps();
        }

        function removeFunnelStep(stepId) {
            if (funnelConfig.steps.length <= 1) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ­¥éª¤');
                return;
            }
            
            funnelConfig.steps = funnelConfig.steps.filter(step => step.id !== stepId);
            renderFunnelSteps();
        }

        function updateStepEvent(stepId, eventType) {
            const step = funnelConfig.steps.find(s => s.id === stepId);
            if (step) {
                step.event = eventType;
                step.eventName = getEventName(eventType);
            }
        }

        function getEventName(eventType) {
            const eventNames = {
                'page_click': 'é¡µé¢ç‚¹å‡»ã€é€šç”¨æ–°ã€‘',
                'page_view': 'é¡µé¢æµè§ˆ',
                'button_click': 'æŒ‰é’®ç‚¹å‡»',
                'form_submit': 'è¡¨å•æäº¤',
                'custom_event': 'è‡ªå®šä¹‰äº‹ä»¶'
            };
            return eventNames[eventType] || eventType;
        }

        function addFilter(stepId) {
            const step = funnelConfig.steps.find(s => s.id === stepId);
            if (step) {
                step.filters.push({
                    field: 'builtin_id',
                    operator: 'empty',
                    value: ''
                });
                renderFunnelSteps();
            }
        }

        function removeFilter(stepId, filterIndex) {
            const step = funnelConfig.steps.find(s => s.id === stepId);
            if (step && step.filters.length > 1) {
                step.filters.splice(filterIndex, 1);
                renderFunnelSteps();
            }
        }

        function updateFilterField(stepId, filterIndex, field, value) {
            const step = funnelConfig.steps.find(s => s.id === stepId);
            if (step && step.filters[filterIndex]) {
                step.filters[filterIndex][field] = value;
            }
        }

        function saveFunnelConfig() {
            // æ”¶é›†è¡¨å•æ•°æ®
            funnelConfig.name = document.getElementById('funnelName').value;
            funnelConfig.conversionCycle = parseInt(document.getElementById('conversionCycle').value);
            
            const activeChartType = document.querySelector('.chart-type-btn.active');
            funnelConfig.defaultChartType = activeChartType ? activeChartType.dataset.type : 'funnel';
            
            const countIdRadio = document.querySelector('input[name="countId"]:checked');
            funnelConfig.countId = countIdRadio ? countIdRadio.value : 'builtin';
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!funnelConfig.name.trim()) {
                alert('è¯·è¾“å…¥æ¼æ–—åç§°');
                return;
            }
            
            if (funnelConfig.steps.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæ­¥éª¤');
                return;
            }
            
            // åˆ‡æ¢åˆ°é»˜è®¤å›¾è¡¨ç±»å‹
            currentFunnelTab = funnelConfig.defaultChartType;
            updateFunnelTabs();
            
            // ä¿å­˜é…ç½®å¹¶å…³é—­ç¼–è¾‘å™¨
            closeFunnelEditor();
            showMessage('æ¼æ–—é…ç½®å·²ä¿å­˜', 'success');
            
            // æ›´æ–°æ¼æ–—å›¾æ ‡é¢˜
            document.getElementById('funnelConfigName').textContent = `${funnelConfig.name} - åŸºäºæ¼æ–—é…ç½®ç”Ÿæˆ`;
            
            // å¦‚æœæœ‰æ•°æ®ï¼Œé‡æ–°ç”Ÿæˆæ¼æ–—å›¾
            if (convertedData.length > 0) {
                updateFunnelChart();
            }
        }

        // å›¾è¡¨ç±»å‹æŒ‰é’®åˆ‡æ¢
        document.addEventListener('click', function(e) {
            if (e.target.closest('.chart-type-btn')) {
                document.querySelectorAll('.chart-type-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                e.target.closest('.chart-type-btn').classList.add('active');
            }
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            // åˆå§‹åŒ–æ¼æ–—å›¾
            const chartDom = document.getElementById('funnelChart');
            if (chartDom) {
                funnelChart = echarts.init(chartDom);
                // æ˜¾ç¤ºåˆå§‹çŠ¶æ€
                updateEChartsFunnel([]);
            }
        });

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´å›¾è¡¨
        window.addEventListener('resize', function() {
            if (funnelChart) {
                funnelChart.resize();
            }
        });
    </script>
</body>
</html>
